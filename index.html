<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LazyBala - è´¹åŠ²å·´æ‹‰ä¸‹è½½å™¨</title>
  <meta name="description" content="LazyBala - éä¸“ä¸šçš„å¥—å£³ä¸‹è½½å·¥å…·ï¼Œæ”¯æŒå“”å“©å“”å“©æœ‰å£°éŸ³é¢‘ä¸‹è½½">
  <meta name="keywords" content="ä¸‹è½½å·¥å…·,æœ‰å£°éŸ³é¢‘ä¸‹è½½å™¨">
  <meta name="author" content="Kis2Show">
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¦«</text></svg>">
  <style>
    :root {
      --bg-primary: #1c1c1e;
      --bg-secondary: #2c2c2e;
      --bg-tertiary: #3a3a3c;
      --text-primary: #ffffff;
      --text-secondary: #8e8e93;
      --border-color: #48484a;
      --primary-color: #ff6b35;
      --primary-hover: #e55a2b;
    }

    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f2f2f7;
      --bg-tertiary: #e5e5ea;
      --text-primary: #000000;
      --text-secondary: #6d6d70;
      --border-color: #c6c6c8;
      --primary-color: #ff6b35;
      --primary-hover: #e55a2b;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin: 0;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .header {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-center {
      flex: 1;
      text-align: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .theme-toggle {
      background: var(--bg-tertiary);
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: var(--border-color);
    }

    .settings-btn {
      background: var(--bg-tertiary);
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      background: var(--border-color);
    }

    .input-box {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .input-field {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 16px;
      margin-bottom: 10px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .input-hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .button-group {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 20px;
    }

    .shortcut-hint {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--primary-hover);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    /* è®¾ç½®å¼¹çª— */
    .settings-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .settings-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-content {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .settings-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      color: var(--text-primary);
    }

    .setting-group {
      margin-bottom: 20px;
    }

    .setting-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .setting-desc {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .setting-switch {
      position: relative;
      width: 50px;
      height: 28px;
      background: var(--bg-tertiary);
      border-radius: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .setting-switch.active {
      background: var(--primary-color);
    }

    .setting-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .setting-switch.active::after {
      transform: translateX(22px);
    }

    .setting-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .setting-info.success {
      background: rgba(52, 199, 89, 0.1);
      border: 1px solid rgba(52, 199, 89, 0.3);
    }

    .setting-info.warning {
      background: rgba(255, 149, 0, 0.1);
      border: 1px solid rgba(255, 149, 0, 0.3);
    }

    .setting-info.error {
      background: rgba(255, 59, 48, 0.1);
      border: 1px solid rgba(255, 59, 48, 0.3);
    }

    .setting-tabs {
      display: flex;
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 20px;
    }

    .setting-tab {
      flex: 1;
      padding: 8px 12px;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .setting-tab.active {
      background: var(--primary-color);
      color: white;
    }

    .setting-content {
      display: none;
    }

    .setting-content.active {
      display: block;
    }

    .login-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    .status-dot.online {
      background: #34c759;
    }

    .status-dot.offline {
      background: #ff3b30;
    }

    .qr-container {
      text-align: center;
      padding: 20px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .qr-code {
      width: 200px;
      height: 200px;
      margin: 0 auto 15px;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn-group .btn {
      flex: 1;
      margin-right: 0;
    }

    /* å†å²è®°å½•æ ·å¼ */
    .history-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }

    .history-item:hover {
      background: var(--border-color);
    }

    .history-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 18px;
    }

    .history-icon.success {
      background: #34c759;
    }

    .history-icon.error {
      background: #ff3b30;
    }

    .history-icon.warning {
      background: #ff9500;
    }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-title {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-meta {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      gap: 12px;
    }

    .history-actions {
      display: flex;
      gap: 8px;
    }

    .history-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      background: var(--bg-primary);
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .history-btn:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    /* è¿›åº¦æ¡æ ·å¼ */
    .mini-progress {
      width: 60px;
      height: 4px;
      background: var(--bg-primary);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }

    .mini-progress-fill {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.3s;
    }

    /* é”®ç›˜æŒ‰é”®æ ·å¼ */
    kbd {
      display: inline-block;
      padding: 2px 6px;
      font-size: 11px;
      line-height: 1.4;
      color: var(--text-primary);
      background-color: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      box-shadow: 0 1px 0 var(--border-color);
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-weight: 500;
    }

    /* å¢å¼ºçš„è¿›åº¦æ˜¾ç¤ºæ ·å¼ */
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .progress-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .progress-title h3 {
      margin: 0;
      font-size: 18px;
    }

    .progress-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .download-phase {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .download-phase.initializing {
      background: #007aff;
      color: white;
    }

    .download-phase.extracting {
      background: #ff9500;
      color: white;
    }

    .download-phase.downloading {
      background: #34c759;
      color: white;
    }

    .download-phase.merging {
      background: #af52de;
      color: white;
    }

    .download-phase.completed {
      background: #30d158;
      color: white;
    }

    .download-phase.error {
      background: #ff3b30;
      color: white;
    }

    .ws-status {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .ws-status.connected {
      background: #30d158;
      color: white;
    }

    .ws-status.disconnected {
      background: #8e8e93;
      color: white;
    }

    .progress-details {
      margin-top: 15px;
    }

    .progress-detail-item {
      margin: 8px 0;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .progress-stats {
      display: flex;
      gap: 15px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .progress-stat {
      padding: 4px 8px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .metadata-container {
      margin: 15px 0;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid var(--primary-color);
    }

    .metadata-item {
      margin: 6px 0;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .completed-files {
      margin: 15px 0;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid #30d158;
      max-height: 120px;
      overflow-y: auto;
    }

    .completed-title {
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .completed-file {
      margin: 4px 0;
      font-size: 12px;
      color: var(--text-secondary);
      padding: 2px 0;
    }

    /* ä½¿ç”¨è¯´æ˜æ ·å¼ */
    .usage-tips {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .tip-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 15px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid var(--primary-color);
    }

    .tip-icon {
      font-size: 20px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .tip-content {
      flex: 1;
    }

    .tip-content strong {
      color: var(--text-primary);
      display: block;
      margin-bottom: 8px;
    }

    .tip-content ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
      color: var(--text-secondary);
    }

    .tip-content li {
      margin: 4px 0;
      font-size: 13px;
      line-height: 1.4;
    }

    .tip-content p {
      margin: 4px 0;
      color: var(--text-secondary);
      font-size: 13px;
      line-height: 1.4;
    }

    .tip-content code {
      background: var(--bg-primary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 12px;
      color: var(--primary-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">ğŸŒ™</button>
      </div>
      <div class="header-center">
        <h1>LazyBala</h1>
        <p>è´¹åŠ²å·´æ‹‰ä¸‹è½½å™¨</p>
      </div>
      <div class="header-right">
        <button class="settings-btn" onclick="showSettings()">âš™ï¸</button>
      </div>
    </div>

    <div class="input-box">
      <h3>ğŸ“¥ è¾“å…¥ä¸‹è½½ä¿¡æ¯</h3>

      <div class="input-group">
        <label class="input-label">ğŸ”— è§†é¢‘é“¾æ¥</label>
        <input type="text" class="input-field" placeholder="è¯·è¾“å…¥å“”å“©å“”å“©è§†é¢‘é“¾æ¥ï¼Œå¦‚ï¼šhttps://www.bilibili.com/video/BV1YeXDYTELy" id="urlInput">
        <div class="input-hint">
          æ”¯æŒå•ä¸ªè§†é¢‘ã€æ’­æ”¾åˆ—è¡¨ã€åˆé›†ç­‰å¤šç§é“¾æ¥æ ¼å¼
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">ğŸ“ ä¿å­˜è·¯å¾„</label>
        <input type="text" class="input-field" placeholder="æ–‡ä»¶ä¿å­˜çš„å­ç›®å½•åç§°ï¼Œå¦‚ï¼štestã€éŸ³ä¹ã€æ•™ç¨‹ç­‰" value="test" id="pathInput">
        <div class="input-hint">
          æ–‡ä»¶å°†ä¿å­˜åˆ° audiobooks/[æ‚¨è¾“å…¥çš„è·¯å¾„]/ ç›®å½•ä¸‹
        </div>
      </div>

      <div class="button-group">
        <button class="btn" onclick="testCheck()">ğŸ” æ£€æŸ¥åˆ—è¡¨</button>
        <div class="shortcut-hint">
          å¿«æ·é”®ï¼š<kbd>Ctrl</kbd> + <kbd>Enter</kbd>
        </div>
      </div>
    </div>

    <div class="input-box" id="resultBox" style="display: none;">
      <h3>æ£€æŸ¥ç»“æœ</h3>
      <p id="resultText">ç­‰å¾…æ£€æŸ¥...</p>
      <button class="btn" onclick="testDownload()">å¼€å§‹ä¸‹è½½</button>
      <button class="btn btn-secondary" onclick="hideResult()">å–æ¶ˆ</button>
    </div>

    <div class="input-box" id="progressBox" style="display: none;">
      <div class="progress-header">
        <div class="progress-title">
          <h3>ä¸‹è½½è¿›åº¦</h3>
          <span id="downloadPhase" class="download-phase"></span>
        </div>
        <div class="progress-controls">
          <span id="wsStatus" class="ws-status">æœªè¿æ¥</span>
          <button class="btn btn-secondary" onclick="pauseResumeDownload()" id="pauseResumeBtn" style="display: none;">æš‚åœä¸‹è½½</button>
          <button class="btn btn-secondary" onclick="stopDownload()">åœæ­¢ä¸‹è½½</button>
          <button class="btn" onclick="restartDownload()" id="restartBtn" style="display: none;">é‡æ–°ä¸‹è½½</button>
        </div>
      </div>

      <div style="background: #3a3a3c; height: 10px; border-radius: 5px; margin: 10px 0;">
        <div id="progressBar" style="background: #ff6b35; height: 100%; width: 0%; border-radius: 5px; transition: width 0.3s;"></div>
      </div>

      <div class="progress-details">
        <p id="progressText">å‡†å¤‡ä¸‹è½½...</p>
        <div id="currentFile" class="progress-detail-item"></div>
        <div id="playlistProgress" class="progress-detail-item" style="display: none;"></div>

        <div class="progress-stats">
          <div id="downloadSpeed" class="progress-stat" style="display: none;"></div>
          <div id="downloadETA" class="progress-stat" style="display: none;"></div>
          <div id="fileSize" class="progress-stat" style="display: none;"></div>
        </div>
      </div>

      <!-- å…ƒæ•°æ®ä¿¡æ¯ -->
      <div id="metadata" class="metadata-container" style="display: none;"></div>

      <!-- å·²å®Œæˆæ–‡ä»¶ -->
      <div id="completedFiles" class="completed-files" style="display: none;"></div>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜ -->
    <div class="input-box" style="margin-top: 30px;">
      <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
      <div class="usage-tips">
        <div class="tip-item">
          <span class="tip-icon">ğŸ”—</span>
          <div class="tip-content">
            <strong>æ”¯æŒçš„é“¾æ¥æ ¼å¼ï¼š</strong>
            <ul>
              <li>å•ä¸ªè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1234567890</li>
              <li>æ’­æ”¾åˆ—è¡¨ï¼šhttps://www.bilibili.com/playlist?list=...</li>
              <li>åˆé›†ï¼šhttps://space.bilibili.com/uid/channel/collectiondetail?sid=...</li>
              <li>UPä¸»ç©ºé—´ï¼šhttps://space.bilibili.com/uid</li>
            </ul>
          </div>
        </div>

        <div class="tip-item">
          <span class="tip-icon">ğŸ“</span>
          <div class="tip-content">
            <strong>ä¿å­˜è·¯å¾„è¯´æ˜ï¼š</strong>
            <p>æ–‡ä»¶å°†ä¿å­˜åˆ° <code>audiobooks/[æ‚¨è¾“å…¥çš„è·¯å¾„]/</code> ç›®å½•ä¸‹</p>
            <p>å»ºè®®ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°ï¼Œå¦‚ï¼šéŸ³ä¹ã€æ•™ç¨‹ã€æœ‰å£°ä¹¦ç­‰</p>
          </div>
        </div>

        <div class="tip-item">
          <span class="tip-icon">âŒ¨ï¸</span>
          <div class="tip-content">
            <strong>å¿«æ·é”®ï¼š</strong>
            <ul>
              <li><kbd>Ctrl</kbd> + <kbd>Enter</kbd> - å¿«é€Ÿæ£€æŸ¥åˆ—è¡¨</li>
              <li><kbd>Ctrl</kbd> + <kbd>,</kbd> - æ‰“å¼€è®¾ç½®</li>
              <li><kbd>Ctrl</kbd> + <kbd>D</kbd> - åˆ‡æ¢ä¸»é¢˜</li>
              <li><kbd>Escape</kbd> - å…³é—­è®¾ç½®</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®å¼¹çª— -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2 class="settings-title">è®¾ç½®</h2>
        <button class="close-btn" onclick="hideSettings()">Ã—</button>
      </div>

      <!-- æ ‡ç­¾é¡µ -->
      <div class="setting-tabs">
        <div class="setting-tab active" onclick="switchTab('download')">ä¸‹è½½è®¾ç½®</div>
        <div class="setting-tab" onclick="switchTab('account')">è´¦å·ç®¡ç†</div>
        <div class="setting-tab" onclick="switchTab('history')">ä¸‹è½½å†å²</div>
        <div class="setting-tab" onclick="switchTab('about')">å…³äº</div>
      </div>

      <!-- ä¸‹è½½è®¾ç½®æ ‡ç­¾é¡µ -->
      <div class="setting-content active" id="downloadTab">
        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="setting-info" id="systemStatus">
          <span>ğŸ”§</span>
          <div>
            <div style="font-weight: 500;">ç³»ç»ŸçŠ¶æ€</div>
            <div style="font-size: 12px; color: var(--text-secondary);" id="systemStatusText">æ£€æŸ¥ä¸­...</div>
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">ğŸ“ ä¿å­˜è·¯å¾„</label>
          <div class="setting-desc">ä¸‹è½½æ–‡ä»¶çš„ä¿å­˜ç›®å½•ï¼Œç›¸å¯¹äºç¨‹åºæ ¹ç›®å½•</div>
          <input type="text" class="input-field" id="settingSavePath" placeholder="audiobooks/test">
          <div class="setting-desc" style="margin-top: 6px; font-size: 11px;">
            ğŸ’¡ ç¤ºä¾‹ï¼šaudiobooks/éŸ³ä¹ã€audiobooks/æ•™ç¨‹ã€downloads/æœ‰å£°ä¹¦ç­‰
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">ğŸ“ æ–‡ä»¶åæ ¼å¼</label>
          <div class="setting-desc">ä¸‹è½½æ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œæ”¯æŒ %(title)s, %(uploader)s ç­‰å˜é‡</div>
          <select class="input-field" id="settingTitleRegex">
            <option value="%(title)s.%(ext)s">æ ‡é¢˜.æ‰©å±•å (æ¨è)</option>
            <option value="%(uploader)s - %(title)s.%(ext)s">UPä¸» - æ ‡é¢˜.æ‰©å±•å</option>
            <option value="[%(upload_date)s] %(title)s.%(ext)s">[æ—¥æœŸ] æ ‡é¢˜.æ‰©å±•å</option>
            <option value="%(playlist_index)s. %(title)s.%(ext)s">åºå·. æ ‡é¢˜.æ‰©å±•å</option>
            <option value="%(autonumber)s.%(ext)s">åºå·.æ‰©å±•å</option>
            <option value="custom">è‡ªå®šä¹‰æ ¼å¼</option>
          </select>
          <input type="text" class="input-field" id="customTitleRegex" placeholder="å¦‚ï¼š%(title)s - %(uploader)s.%(ext)s" style="display: none; margin-top: 8px;">
          <div class="setting-desc" style="margin-top: 6px; font-size: 11px;">
            ğŸ’¡ å¸¸ç”¨å˜é‡ï¼š%(title)s=æ ‡é¢˜ã€%(uploader)s=UPä¸»ã€%(upload_date)s=ä¸Šä¼ æ—¥æœŸã€%(ext)s=æ‰©å±•å
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">ğŸµ éŸ³è´¨é€‰æ‹©</label>
          <div class="setting-desc">ä¸‹è½½éŸ³é¢‘çš„è´¨é‡è®¾ç½®</div>
          <select class="input-field" id="settingQuality">
            <option value="bestaudio/best">æœ€ä½³éŸ³è´¨ (æ¨èï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ ¼å¼)</option>
            <option value="bestaudio[ext=m4a]/best[ext=m4a]">M4Aæ ¼å¼ (é«˜è´¨é‡ï¼Œå…¼å®¹æ€§å¥½)</option>
            <option value="bestaudio[ext=mp3]/best[ext=mp3]">MP3æ ¼å¼ (é€šç”¨æ€§å¼º)</option>
            <option value="bestaudio[ext=opus]/best[ext=opus]">OPUSæ ¼å¼ (é«˜å‹ç¼©æ¯”)</option>
            <option value="worst">æœ€ä½éŸ³è´¨ (èŠ‚çœç©ºé—´)</option>
          </select>
          <div class="setting-desc" style="margin-top: 6px; font-size: 11px;">
            ğŸ’¡ æ¨èä½¿ç”¨"æœ€ä½³éŸ³è´¨"ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©æœ€é€‚åˆçš„éŸ³é¢‘æ ¼å¼å’Œè´¨é‡
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">ğŸ”„ é‡è¯•æ¬¡æ•°</label>
          <div class="setting-desc">ä¸‹è½½å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°ï¼Œç½‘ç»œä¸ç¨³å®šæ—¶å»ºè®®è®¾ç½®è¾ƒé«˜å€¼</div>
          <input type="range" class="input-field" id="settingRetryCount" min="1" max="10" value="5" oninput="updateRetryDisplay(this.value)">
          <div style="text-align: center; margin-top: 5px; font-size: 14px; color: var(--text-secondary);">
            <span id="retryDisplay">5</span> æ¬¡
          </div>
          <div class="setting-desc" style="margin-top: 6px; font-size: 11px;">
            ğŸ’¡ æ¨èè®¾ç½® 3-5 æ¬¡ï¼Œè¿‡é«˜å¯èƒ½å¯¼è‡´ä¸‹è½½æ—¶é—´è¿‡é•¿
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-row">
            <div>
              <div class="setting-label">ğŸ–¼ï¸ ä¸‹è½½å°é¢</div>
              <div class="setting-desc">åŒæ—¶ä¸‹è½½è§†é¢‘å°é¢å›¾ç‰‡ï¼Œä¾¿äºè¯†åˆ«å†…å®¹</div>
            </div>
            <div class="setting-switch" id="thumbnailSwitch" onclick="toggleSwitch('thumbnailSwitch', 'settingWriteThumbnail')">
            </div>
          </div>
          <input type="hidden" id="settingWriteThumbnail" value="true">
        </div>

        <div class="setting-group">
          <div class="setting-row">
            <div>
              <div class="setting-label">âœï¸ è‡ªåŠ¨é‡å‘½å</div>
              <div class="setting-desc">è‡ªåŠ¨å¤„ç†æ–‡ä»¶åä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œç¡®ä¿å…¼å®¹æ€§</div>
            </div>
            <div class="setting-switch active" id="autoRenameSwitch" onclick="toggleSwitch('autoRenameSwitch', 'settingAutoRename')">
            </div>
          </div>
          <input type="hidden" id="settingAutoRename" value="true">
        </div>

        <div class="btn-group">
          <button class="btn" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
          <button class="btn btn-secondary" onclick="resetSettings()">é‡ç½®é»˜è®¤</button>
        </div>
      </div>

      <!-- è´¦å·ç®¡ç†æ ‡ç­¾é¡µ -->
      <div class="setting-content" id="accountTab">
        <!-- ç™»å½•çŠ¶æ€ -->
        <div class="login-status" id="loginStatus">
          <div class="status-dot offline" id="statusDot"></div>
          <div>
            <div style="font-weight: 500;" id="loginStatusText">æœªç™»å½•</div>
            <div style="font-size: 12px; color: var(--text-secondary);" id="loginStatusDesc">ç™»å½•åå¯ä¸‹è½½ä¼šå‘˜ä¸“äº«å†…å®¹</div>
          </div>
        </div>

        <!-- äºŒç»´ç ç™»å½• -->
        <div class="qr-container" id="qrContainer" style="display: none;">
          <div class="qr-code" id="qrCode">
            <div>è¯·ä½¿ç”¨å“”å“©å“”å“©APPæ‰«ç ç™»å½•</div>
          </div>
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">
            æ‰«ç åè¯·åœ¨APPä¸­ç¡®è®¤ç™»å½•
          </div>
          <div style="font-size: 12px; color: var(--text-secondary);">
            äºŒç»´ç æœ‰æ•ˆæœŸ: <span id="qrExpiry">180</span>ç§’
          </div>
        </div>

        <div class="btn-group">
          <button class="btn" onclick="generateQRCode()" id="loginBtn">ç”Ÿæˆç™»å½•äºŒç»´ç </button>
          <button class="btn btn-secondary" onclick="forceGenerateQRCode()" id="forceLoginBtn">å¼ºåˆ¶é‡æ–°ç™»å½•</button>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="clearCookies()">æ¸…é™¤ç™»å½•ä¿¡æ¯</button>
          <button class="btn btn-secondary" onclick="exportCookies()">å¯¼å‡ºCookies</button>
        </div>

        <!-- è´¦å·ä¿¡æ¯ -->
        <div class="setting-group" id="accountInfo" style="display: none;">
          <label class="setting-label">è´¦å·ä¿¡æ¯</label>
          <div class="setting-info" id="userInfo">
            <span>ğŸ‘¤</span>
            <div>
              <div style="font-weight: 500;" id="userName">åŠ è½½ä¸­...</div>
              <div style="font-size: 12px; color: var(--text-secondary);" id="userLevel">è·å–ç”¨æˆ·ä¿¡æ¯ä¸­...</div>
            </div>
          </div>
          <div class="setting-info" id="memberInfo" style="display: none;">
            <span>ğŸ’</span>
            <div>
              <div style="font-weight: 500;" id="memberType">ä¼šå‘˜ç±»å‹</div>
              <div style="font-size: 12px; color: var(--text-secondary);" id="memberExpiry">åˆ°æœŸæ—¶é—´</div>
            </div>
          </div>
          <div class="setting-info" id="statsInfo" style="display: none;">
            <span>ğŸ“Š</span>
            <div>
              <div style="font-weight: 500;">è´¦å·ç»Ÿè®¡</div>
              <div style="font-size: 12px; color: var(--text-secondary);" id="userStats">å…³æ³¨/ç²‰ä¸/è·èµ</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¸‹è½½å†å²æ ‡ç­¾é¡µ -->
      <div class="setting-content" id="historyTab">
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="setting-info">
          <span>ğŸ“Š</span>
          <div>
            <div style="font-weight: 500;">ä¸‹è½½ç»Ÿè®¡</div>
            <div style="font-size: 12px; color: var(--text-secondary);" id="downloadStats">æ€»è®¡ä¸‹è½½: 0 ä¸ªæ–‡ä»¶</div>
          </div>
        </div>

        <!-- ç­›é€‰é€‰é¡¹ -->
        <div class="setting-group">
          <label class="setting-label">ç­›é€‰æ¡ä»¶</label>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="filterHistory('all')" id="filterAll">å…¨éƒ¨</button>
            <button class="btn btn-secondary" onclick="filterHistory('completed')" id="filterCompleted">å·²å®Œæˆ</button>
            <button class="btn btn-secondary" onclick="filterHistory('failed')" id="filterFailed">å¤±è´¥</button>
          </div>
        </div>

        <!-- å†å²è®°å½•åˆ—è¡¨ -->
        <div class="setting-group">
          <label class="setting-label">ä¸‹è½½å†å²</label>
          <div id="historyList" style="max-height: 300px; overflow-y: auto;">
            <div class="setting-info" style="text-align: center; color: var(--text-secondary);">
              <span>ğŸ“</span>
              <div>æš‚æ— ä¸‹è½½è®°å½•</div>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="refreshHistory()">åˆ·æ–°å†å²</button>
          <button class="btn btn-secondary" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
        </div>

        <!-- ç”Ÿäº§æ¨¡å¼ä¸‹éšè—å¯¼å‡ºå’Œæ‰“å¼€ç›®å½•åŠŸèƒ½ -->
        <div class="btn-group" style="display: none;">
          <button class="btn btn-secondary" onclick="exportHistory()">å¯¼å‡ºå†å²</button>
          <button class="btn btn-secondary" onclick="openDownloadFolder()">æ‰“å¼€ä¸‹è½½ç›®å½•</button>
        </div>
      </div>

      <!-- å…³äºæ ‡ç­¾é¡µ -->
      <div class="setting-content" id="aboutTab">
        <div class="setting-info">
          <span>ğŸµ</span>
          <div>
            <div style="font-weight: 500;">LazyBala</div>
            <div style="font-size: 12px; color: var(--text-secondary);">è´¹åŠ²å·´æ‹‰ä¸‹è½½å™¨ v1.0.0</div>
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">åŠŸèƒ½ç‰¹è‰²</label>
          <div class="setting-desc">
            â€¢ æ”¯æŒå“”å“©å“”å“©éŸ³é¢‘ä¸‹è½½<br>
            â€¢ æ‰¹é‡ä¸‹è½½æ’­æ”¾åˆ—è¡¨<br>
            â€¢ è‡ªåŠ¨è·å–æœ€ä½³éŸ³è´¨<br>
            â€¢ æ”¯æŒä¼šå‘˜ä¸“äº«å†…å®¹<br>
            â€¢ å®æ—¶ä¸‹è½½è¿›åº¦æ˜¾ç¤º
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">æŠ€æœ¯æ ˆ</label>
          <div class="setting-desc">
            â€¢ åç«¯: Go + Gin + WebSocket<br>
            â€¢ å‰ç«¯: çº¯HTML + CSS + JavaScript<br>
            â€¢ ä¸‹è½½: yt-dlp + ffmpeg<br>
            â€¢ å®¹å™¨: Dockeræ”¯æŒ
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">å¿«æ·é”®</label>
          <div class="setting-desc">
            â€¢ <kbd>Ctrl/Cmd + Enter</kbd> å¿«é€Ÿæ£€æŸ¥åˆ—è¡¨<br>
            â€¢ <kbd>Ctrl/Cmd + ,</kbd> æ‰“å¼€è®¾ç½®<br>
            â€¢ <kbd>Ctrl/Cmd + D</kbd> åˆ‡æ¢ä¸»é¢˜<br>
            â€¢ <kbd>Ctrl/Cmd + H</kbd> æŸ¥çœ‹å†å²<br>
            â€¢ <kbd>Escape</kbd> å…³é—­è®¾ç½®
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">ç‰ˆæœ¬ä¿¡æ¯</label>
          <div class="setting-info" id="versionInfo">
            <span>ğŸ“¦</span>
            <div>
              <div style="font-weight: 500;">æ£€æŸ¥æ›´æ–°</div>
              <div style="font-size: 12px; color: var(--text-secondary);" id="versionText">å½“å‰ç‰ˆæœ¬: v1.0.0</div>
            </div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="checkUpdate()">æ£€æŸ¥æ›´æ–°</button>
          <button class="btn btn-secondary" onclick="updateYtDlp()" id="updateYtDlpBtn">æ›´æ–° yt-dlp</button>
          <button class="btn btn-secondary" onclick="viewLogs()">æŸ¥çœ‹æ—¥å¿—</button>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="openGithub()">GitHubé¡¹ç›®</button>
          <button class="btn btn-secondary" onclick="reportIssue()">åé¦ˆé—®é¢˜</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    console.log('æµ‹è¯•é¡µé¢å·²åŠ è½½');

    // å…¨å±€å˜é‡
    let downloadHistory = [];
    let currentFilter = 'all';

    // ä¸»é¢˜ç®¡ç†
    let currentTheme = localStorage.getItem('theme') || 'dark';

    // åˆå§‹åŒ–ä¸»é¢˜
    function initTheme() {
      if (currentTheme === 'light') {
        document.body.setAttribute('data-theme', 'light');
        document.getElementById('themeToggle').textContent = 'â˜€ï¸';
      } else {
        document.body.removeAttribute('data-theme');
        document.getElementById('themeToggle').textContent = 'ğŸŒ™';
      }
    }

    // åˆ‡æ¢ä¸»é¢˜
    function toggleTheme() {
      currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', currentTheme);
      initTheme();
    }

    // æ˜¾ç¤ºè®¾ç½®
    function showSettings() {
      loadSettings();
      document.getElementById('settingsModal').classList.add('show');
    }

    // éšè—è®¾ç½®
    function hideSettings() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    // åŠ è½½è®¾ç½®
    async function loadSettings() {
      try {
        const response = await fetch('/api/config');
        if (response.ok) {
          const config = await response.json();

          // åŸºæœ¬è®¾ç½®
          document.getElementById('settingSavePath').value = config.save_path || '';

          // æ–‡ä»¶åæ ¼å¼
          const titleRegex = config.title_regex || '%(title)s.%(ext)s';
          const titleSelect = document.getElementById('settingTitleRegex');
          const customInput = document.getElementById('customTitleRegex');

          // æ£€æŸ¥æ˜¯å¦æ˜¯é¢„è®¾æ ¼å¼
          let isCustom = true;
          for (let option of titleSelect.options) {
            if (option.value === titleRegex && option.value !== 'custom') {
              titleSelect.value = titleRegex;
              isCustom = false;
              break;
            }
          }

          if (isCustom) {
            titleSelect.value = 'custom';
            customInput.value = titleRegex;
            customInput.style.display = 'block';
          }

          // éŸ³è´¨è®¾ç½®
          document.getElementById('settingQuality').value = config.quality || 'bestaudio/best';

          // é‡è¯•æ¬¡æ•°
          const retryCount = config.retry_count || 5;
          document.getElementById('settingRetryCount').value = retryCount;
          document.getElementById('retryDisplay').textContent = retryCount;

          // å¼€å…³è®¾ç½®
          const writeThumbnail = config.write_thumbnail !== false;
          document.getElementById('settingWriteThumbnail').value = writeThumbnail ? 'true' : 'false';
          const thumbnailSwitch = document.getElementById('thumbnailSwitch');
          if (writeThumbnail) {
            thumbnailSwitch.classList.add('active');
          } else {
            thumbnailSwitch.classList.remove('active');
          }

          // è‡ªåŠ¨é‡å‘½åé»˜è®¤å¼€å¯
          document.getElementById('settingAutoRename').value = 'true';
          document.getElementById('autoRenameSwitch').classList.add('active');
        }
      } catch (error) {
        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
      }
    }

    // ä¿å­˜è®¾ç½®
    async function saveSettings() {
      // è·å–æ–‡ä»¶åæ ¼å¼
      const titleSelect = document.getElementById('settingTitleRegex');
      let titleRegex = titleSelect.value;
      if (titleRegex === 'custom') {
        titleRegex = document.getElementById('customTitleRegex').value;
      }

      const settings = {
        save_path: document.getElementById('settingSavePath').value,
        title_regex: titleRegex,
        quality: document.getElementById('settingQuality').value,
        retry_count: parseInt(document.getElementById('settingRetryCount').value),
        write_thumbnail: document.getElementById('settingWriteThumbnail').value === 'true',
        auto_rename: document.getElementById('settingAutoRename').value === 'true'
      };

      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          const statusEl = document.getElementById('systemStatus');
          const statusTextEl = document.getElementById('systemStatusText');
          statusEl.className = 'setting-info success';
          statusTextEl.textContent = 'è®¾ç½®å·²ä¿å­˜';

          setTimeout(() => {
            checkSystemStatus();
          }, 2000);
        } else {
          alert('ä¿å­˜è®¾ç½®å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
        alert('ä¿å­˜è®¾ç½®å¤±è´¥');
      }
    }

    // é‡ç½®è®¾ç½®
    function resetSettings() {
      document.getElementById('settingSavePath').value = '';
      document.getElementById('settingTitleRegex').value = '%(title)s.%(ext)s';
      document.getElementById('customTitleRegex').style.display = 'none';
      document.getElementById('settingQuality').value = 'bestaudio/best';
      document.getElementById('settingRetryCount').value = 5;
      document.getElementById('retryDisplay').textContent = '5';

      // é‡ç½®å¼€å…³
      document.getElementById('thumbnailSwitch').classList.add('active');
      document.getElementById('settingWriteThumbnail').value = 'true';
      document.getElementById('autoRenameSwitch').classList.add('active');
      document.getElementById('settingAutoRename').value = 'true';
    }

    // æ–‡ä»¶åæ ¼å¼é€‰æ‹©äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      const titleSelect = document.getElementById('settingTitleRegex');
      const customInput = document.getElementById('customTitleRegex');

      titleSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          customInput.style.display = 'block';
          customInput.focus();
        } else {
          customInput.style.display = 'none';
        }
      });
    });

    // æ˜¾ç¤ºç™»å½•å¯¹è¯æ¡†
    function showLoginDialog() {
      alert('ç™»å½•åŠŸèƒ½å¼€å‘ä¸­...\nå°†æ”¯æŒäºŒç»´ç ç™»å½•è·å–cookies');
    }

    // æ¸…é™¤cookies
    async function clearCookies() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤ç™»å½•ä¿¡æ¯å—ï¼Ÿ\næ¸…é™¤åå°†æ— æ³•ä¸‹è½½ä¼šå‘˜ä¸“äº«å†…å®¹ã€‚')) {
        try {
          // å‘é€æ¸…é™¤cookiesè¯·æ±‚
          const response = await fetch('/api/auth/logout', { method: 'POST' });

          if (response.ok) {
            // æ›´æ–°UIçŠ¶æ€
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('loginStatusText');
            const statusDesc = document.getElementById('loginStatusDesc');

            statusDot.className = 'status-dot offline';
            statusText.textContent = 'æœªç™»å½•';
            statusDesc.textContent = 'ç™»å½•åå¯ä¸‹è½½ä¼šå‘˜ä¸“äº«å†…å®¹';
            document.getElementById('accountInfo').style.display = 'none';

            // éšè—äºŒç»´ç 
            document.getElementById('qrContainer').style.display = 'none';

            // æ›´æ–°ç³»ç»ŸçŠ¶æ€
            checkSystemStatus();

            alert('ç™»å½•ä¿¡æ¯å·²æ¸…é™¤');
          } else {
            // å³ä½¿åç«¯æ²¡æœ‰å¯¹åº”APIï¼Œä¹Ÿæ¨¡æ‹Ÿæ¸…é™¤æˆåŠŸ
            alert('ç™»å½•ä¿¡æ¯å·²æ¸…é™¤');
            updateLoginStatus();
          }
        } catch (error) {
          console.error('æ¸…é™¤ç™»å½•ä¿¡æ¯å¤±è´¥:', error);
          alert('æ¸…é™¤ç™»å½•ä¿¡æ¯å¤±è´¥: ' + error.message);
        }
      }
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.getElementById('settingsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideSettings();
      }
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– (å·²ç§»è‡³WebSocketåˆå§‹åŒ–å¤„)

    // è®¾ç½®é”®ç›˜å¿«æ·é”®
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Enter: å¿«é€Ÿæ£€æŸ¥åˆ—è¡¨
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          handleCheckList();
        }

        // Ctrl/Cmd + ,: æ‰“å¼€è®¾ç½®
        if ((e.ctrlKey || e.metaKey) && e.key === ',') {
          e.preventDefault();
          showSettings();
        }

        // Escape: å…³é—­è®¾ç½®
        if (e.key === 'Escape') {
          hideSettings();
        }

        // Ctrl/Cmd + D: åˆ‡æ¢ä¸»é¢˜
        if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
          e.preventDefault();
          toggleTheme();
        }

        // Ctrl/Cmd + H: æŸ¥çœ‹å†å²
        if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
          e.preventDefault();
          showSettings();
          setTimeout(() => switchTab('history'), 100);
        }
      });
    }

    // æ ‡ç­¾é¡µåˆ‡æ¢
    function switchTab(tabName) {
      // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
      document.querySelectorAll('.setting-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.setting-content').forEach(content => content.classList.remove('active'));

      // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');

      // æ ¹æ®æ ‡ç­¾é¡µæ‰§è¡Œç›¸åº”æ“ä½œ
      if (tabName === 'account') {
        updateLoginStatus();
      } else if (tabName === 'history') {
        refreshHistory();
      }
    }

    // å¼€å…³åˆ‡æ¢
    function toggleSwitch(switchId, inputId) {
      const switchEl = document.getElementById(switchId);
      const inputEl = document.getElementById(inputId);

      switchEl.classList.toggle('active');
      inputEl.value = switchEl.classList.contains('active') ? 'true' : 'false';
    }

    // æ›´æ–°é‡è¯•æ¬¡æ•°æ˜¾ç¤º
    function updateRetryDisplay(value) {
      document.getElementById('retryDisplay').textContent = value;
    }

    // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
    async function checkSystemStatus() {
      try {
        const response = await fetch('/api/config');
        if (response.ok) {
          const config = await response.json();
          const statusEl = document.getElementById('systemStatus');
          const statusTextEl = document.getElementById('systemStatusText');

          if (config.has_cookies && config.cookies_valid) {
            statusEl.className = 'setting-info success';
            statusTextEl.textContent = 'ç³»ç»Ÿæ­£å¸¸ï¼Œå·²ç™»å½•';
          } else {
            statusEl.className = 'setting-info warning';
            statusTextEl.textContent = 'ç³»ç»Ÿæ­£å¸¸ï¼Œæœªç™»å½•';
          }
        }
      } catch (error) {
        const statusEl = document.getElementById('systemStatus');
        const statusTextEl = document.getElementById('systemStatusText');
        statusEl.className = 'setting-info error';
        statusTextEl.textContent = 'ç³»ç»Ÿè¿æ¥å¤±è´¥';
      }
    }

    // æ›´æ–°ç™»å½•çŠ¶æ€
    async function updateLoginStatus() {
      try {
        const response = await fetch('/api/config');
        if (response.ok) {
          const config = await response.json();
          const statusDot = document.getElementById('statusDot');
          const statusText = document.getElementById('loginStatusText');
          const statusDesc = document.getElementById('loginStatusDesc');

          if (config.has_cookies && config.cookies_valid) {
            statusDot.className = 'status-dot online';
            statusText.textContent = 'å·²ç™»å½•';
            statusDesc.textContent = 'å¯ä»¥ä¸‹è½½ä¼šå‘˜ä¸“äº«å†…å®¹';
            document.getElementById('accountInfo').style.display = 'block';
            // è·å–ç”¨æˆ·ä¿¡æ¯
            getUserInfo();
          } else {
            statusDot.className = 'status-dot offline';
            statusText.textContent = 'æœªç™»å½•';
            statusDesc.textContent = 'ç™»å½•åå¯ä¸‹è½½ä¼šå‘˜ä¸“äº«å†…å®¹';
            document.getElementById('accountInfo').style.display = 'none';
          }
        }
      } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
      }
    }

    // è·å–ç”¨æˆ·ä¿¡æ¯
    async function getUserInfo() {
      try {
        const response = await fetch('/api/user/info');
        if (response.ok) {
          const userInfo = await response.json();
          updateUserInfoDisplay(userInfo);
        } else {
          // å¦‚æœAPIä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
          updateUserInfoDisplay({
            name: 'å·²ç™»å½•ç”¨æˆ·',
            level: 'ç­‰çº§ä¿¡æ¯è·å–ä¸­...',
            vip_type: 0,
            vip_status: 0
          });
        }
      } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        // æ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
        updateUserInfoDisplay({
          name: 'å·²ç™»å½•ç”¨æˆ·',
          level: 'ç­‰çº§ä¿¡æ¯è·å–ä¸­...',
          vip_type: 0,
          vip_status: 0
        });
      }
    }

    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
    function updateUserInfoDisplay(userInfo) {
      // åŸºæœ¬ç”¨æˆ·ä¿¡æ¯
      const userNameEl = document.getElementById('userName');
      const userLevelEl = document.getElementById('userLevel');

      if (userNameEl) {
        userNameEl.textContent = userInfo.name || 'ç”¨æˆ·';
      }

      if (userLevelEl) {
        userLevelEl.textContent = `ç­‰çº§ ${userInfo.level || 'N/A'}`;
      }

      // ä¼šå‘˜ä¿¡æ¯
      const memberInfoEl = document.getElementById('memberInfo');
      const memberTypeEl = document.getElementById('memberType');
      const memberExpiryEl = document.getElementById('memberExpiry');

      if (userInfo.vip_status === 1) {
        memberInfoEl.style.display = 'block';
        const vipTypes = {
          0: 'æ— ä¼šå‘˜',
          1: 'æœˆåº¦å¤§ä¼šå‘˜',
          2: 'å¹´åº¦å¤§ä¼šå‘˜'
        };
        memberTypeEl.textContent = vipTypes[userInfo.vip_type] || 'å¤§ä¼šå‘˜';
        memberExpiryEl.textContent = userInfo.vip_due_date ?
          `åˆ°æœŸæ—¶é—´: ${new Date(userInfo.vip_due_date * 1000).toLocaleDateString()}` :
          'ä¼šå‘˜æœ‰æ•ˆ';
      } else {
        memberInfoEl.style.display = 'none';
      }

      // ç»Ÿè®¡ä¿¡æ¯
      const statsInfoEl = document.getElementById('statsInfo');
      const userStatsEl = document.getElementById('userStats');

      if (userInfo.following !== undefined || userInfo.follower !== undefined) {
        statsInfoEl.style.display = 'block';
        userStatsEl.textContent = `å…³æ³¨: ${userInfo.following || 0} | ç²‰ä¸: ${userInfo.follower || 0}`;
      } else {
        statsInfoEl.style.display = 'none';
      }
    }

    // ç”ŸæˆäºŒç»´ç 
    async function generateQRCode() {
      try {
        const response = await fetch('/api/qrcode/generate', { method: 'POST' });
        if (response.ok) {
          const data = await response.json();
          console.log('äºŒç»´ç APIå“åº”:', data);

          if (data.already_logged_in) {
            // å·²ç»ç™»å½•ï¼Œæ˜¾ç¤ºæç¤º
            alert(data.message || 'å·²æˆåŠŸç™»å½•ï¼Œä¸éœ€è¦æ‰«ç ');
            updateLoginStatus(); // æ›´æ–°ç™»å½•çŠ¶æ€æ˜¾ç¤º
            return;
          }

          if (data.qrcode && data.qrcode_key) {
            const qrContainer = document.getElementById('qrContainer');
            const qrCode = document.getElementById('qrCode');

            qrCode.innerHTML = `<img src="data:image/png;base64,${data.qrcode}" style="width: 100%; height: 100%; object-fit: contain;">`;
            qrContainer.style.display = 'block';

            // å¼€å§‹å€’è®¡æ—¶
            startQRCountdown(180);

            // å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkQRLogin(data.qrcode_key);
          } else {
            alert('äºŒç»´ç æ•°æ®æ ¼å¼é”™è¯¯');
          }
        } else {
          const errorData = await response.json();
          alert('ç”ŸæˆäºŒç»´ç å¤±è´¥: ' + (errorData.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
        alert('ç”ŸæˆäºŒç»´ç å¤±è´¥: ' + error.message);
      }
    }

    // äºŒç»´ç å€’è®¡æ—¶
    let qrTimer = null;
    let qrCheckInterval = null;

    function startQRCountdown(seconds) {
      const expiryEl = document.getElementById('qrExpiry');
      let remaining = seconds;

      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (qrTimer) {
        clearInterval(qrTimer);
      }

      qrTimer = setInterval(() => {
        remaining--;
        expiryEl.textContent = remaining;

        if (remaining <= 0) {
          clearInterval(qrTimer);
          // æ¸…é™¤ç™»å½•æ£€æŸ¥å®šæ—¶å™¨
          if (qrCheckInterval) {
            clearInterval(qrCheckInterval);
          }
          // è‡ªåŠ¨é‡æ–°ç”ŸæˆäºŒç»´ç ï¼Œä¸æ˜¾ç¤ºæç¤º
          generateQRCode();
        }
      }, 1000);
    }

    // æ£€æŸ¥äºŒç»´ç ç™»å½•çŠ¶æ€
    async function checkQRLogin(qrcodeKey) {
      // æ¸…é™¤ä¹‹å‰çš„æ£€æŸ¥å®šæ—¶å™¨
      if (qrCheckInterval) {
        clearInterval(qrCheckInterval);
      }

      qrCheckInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/qrcode/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qrcode_key: qrcodeKey })
          });

          if (response.ok) {
            const data = await response.json();
            if (data.code === 0) {
              clearInterval(qrCheckInterval);
              clearInterval(qrTimer); // æ¸…é™¤å€’è®¡æ—¶
              document.getElementById('qrContainer').style.display = 'none';
              alert('ç™»å½•æˆåŠŸï¼');
              updateLoginStatus();
              getUserInfo(); // è·å–ç”¨æˆ·ä¿¡æ¯
            }
          }
        } catch (error) {
          console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        }
      }, 2000);

      // 3åˆ†é’Ÿååœæ­¢æ£€æŸ¥ï¼ˆç”±å€’è®¡æ—¶è‡ªåŠ¨å¤„ç†ï¼‰
      setTimeout(() => {
        if (qrCheckInterval) {
          clearInterval(qrCheckInterval);
        }
      }, 180000);
    }

    // å¼ºåˆ¶ç”ŸæˆäºŒç»´ç 
    async function forceGenerateQRCode() {
      try {
        const response = await fetch('/api/qrcode/force-generate', { method: 'POST' });
        if (response.ok) {
          const data = await response.json();
          console.log('å¼ºåˆ¶ç”ŸæˆäºŒç»´ç APIå“åº”:', data);

          if (data.qrcode && data.qrcode_key) {
            const qrContainer = document.getElementById('qrContainer');
            const qrCode = document.getElementById('qrCode');

            qrCode.innerHTML = `<img src="data:image/png;base64,${data.qrcode}" style="width: 100%; height: 100%; object-fit: contain;">`;
            qrContainer.style.display = 'block';

            // å¼€å§‹å€’è®¡æ—¶
            startQRCountdown(180);

            // å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkQRLogin(data.qrcode_key);
          } else {
            alert('äºŒç»´ç æ•°æ®æ ¼å¼é”™è¯¯');
          }
        } else {
          const errorData = await response.json();
          alert('ç”ŸæˆäºŒç»´ç å¤±è´¥: ' + (errorData.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('å¼ºåˆ¶ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
        alert('å¼ºåˆ¶ç”ŸæˆäºŒç»´ç å¤±è´¥: ' + error.message);
      }
    }

    // å¯¼å‡ºCookies
    async function exportCookies() {
      try {
        const response = await fetch('/api/auth/export-cookies');
        if (response.ok) {
          const data = await response.json();

          if (data.cookies) {
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const cookiesText = data.cookies;
            const blob = new Blob([cookiesText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bilibili_cookies_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            alert('Cookieså¯¼å‡ºæˆåŠŸï¼');
          } else {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„Cookies');
          }
        } else {
          // å¦‚æœAPIä¸å­˜åœ¨ï¼Œå°è¯•è¯»å–æœ¬åœ°cookiesæ–‡ä»¶
          const fallbackResponse = await fetch('/cookies/cookies.txt');
          if (fallbackResponse.ok) {
            const cookiesText = await fallbackResponse.text();
            const blob = new Blob([cookiesText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bilibili_cookies_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            alert('Cookieså¯¼å‡ºæˆåŠŸï¼');
          } else {
            alert('æ²¡æœ‰æ‰¾åˆ°Cookiesæ–‡ä»¶');
          }
        }
      } catch (error) {
        console.error('å¯¼å‡ºCookieså¤±è´¥:', error);
        alert('å¯¼å‡ºCookieså¤±è´¥: ' + error.message);
      }
    }

    // æ£€æŸ¥æ›´æ–°
    async function checkUpdate() {
      try {
        const response = await fetch('/api/version/check');
        if (response.ok) {
          const data = await response.json();

          let message = '=== ç‰ˆæœ¬æ£€æŸ¥ç»“æœ ===\n\n';

          // LazyBalaåº”ç”¨ç‰ˆæœ¬ä¿¡æ¯
          message += 'ğŸ“± LazyBala åº”ç”¨:\n';
          message += `   å½“å‰ç‰ˆæœ¬: ${data.app.current}\n`;
          if (data.app.error) {
            message += `   æ£€æŸ¥å¤±è´¥: ${data.app.error}\n`;
          } else {
            message += `   æœ€æ–°ç‰ˆæœ¬: ${data.app.latest}\n`;
            message += `   çŠ¶æ€: ${data.app.has_update ? 'ğŸ”„ å‘ç°æ–°ç‰ˆæœ¬ï¼' : 'âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬'}\n`;
          }

          message += '\n';

          // yt-dlpç‰ˆæœ¬ä¿¡æ¯
          message += 'ğŸ”§ yt-dlp å·¥å…·:\n';
          message += `   å½“å‰ç‰ˆæœ¬: ${data.ytdlp.current}\n`;
          if (data.ytdlp.error) {
            message += `   æ£€æŸ¥å¤±è´¥: ${data.ytdlp.error}\n`;
          } else {
            message += `   æœ€æ–°ç‰ˆæœ¬: ${data.ytdlp.latest}\n`;
            message += `   çŠ¶æ€: ${data.ytdlp.has_update ? 'ğŸ”„ å‘ç°æ–°ç‰ˆæœ¬ï¼' : 'âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬'}\n`;
          }

          // æ›´æ–°æç¤º
          if (data.app.has_update || data.ytdlp.has_update) {
            message += '\nğŸ’¡ æ›´æ–°æç¤º:\n';
            if (data.app.has_update) {
              message += 'â€¢ LazyBala åº”ç”¨æœ‰æ–°ç‰ˆæœ¬ï¼Œè¯·è®¿é—® GitHub ä¸‹è½½\n';
            }
            if (data.ytdlp.has_update) {
              message += 'â€¢ yt-dlp å·¥å…·æœ‰æ–°ç‰ˆæœ¬ï¼Œå¯åœ¨è®¾ç½®ä¸­ä¸€é”®æ›´æ–°\n';
            }
          }

          alert(message);

          // æ›´æ–°ç‰ˆæœ¬æ˜¾ç¤º
          const versionText = document.getElementById('versionText');
          if (versionText) {
            versionText.textContent = `LazyBala: ${data.app.current} | yt-dlp: ${data.ytdlp.current}`;
          }
        }
      } catch (error) {
        console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
        alert('æ£€æŸ¥æ›´æ–°å¤±è´¥: ' + error.message);
      }
    }

    // æ›´æ–° yt-dlp
    async function updateYtDlp() {
      const updateBtn = document.getElementById('updateYtDlpBtn');
      const originalText = updateBtn.textContent;

      if (!confirm('ç¡®å®šè¦æ›´æ–° yt-dlp åˆ°æœ€æ–°ç‰ˆæœ¬å—ï¼Ÿ\n\næ›´æ–°è¿‡ç¨‹ä¸­ä¸‹è½½åŠŸèƒ½å°†æš‚æ—¶ä¸å¯ç”¨ã€‚')) {
        return;
      }

      try {
        updateBtn.disabled = true;
        updateBtn.textContent = 'æ›´æ–°ä¸­...';

        const response = await fetch('/api/version/update', {
          method: 'POST'
        });

        if (response.ok) {
          const data = await response.json();
          alert('âœ… ' + data.message + '\n\næ›´æ–°å®Œæˆåä¼šè‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯åº”ç”¨ã€‚');

          // 5ç§’åé‡æ–°æ£€æŸ¥ç‰ˆæœ¬
          setTimeout(async () => {
            try {
              const checkResponse = await fetch('/api/version/check');
              if (checkResponse.ok) {
                const versionData = await checkResponse.json();
                const versionText = document.getElementById('versionText');
                if (versionText) {
                  versionText.textContent = `LazyBala: ${versionData.app.current} | yt-dlp: ${versionData.ytdlp.current}`;
                }
              }
            } catch (error) {
              console.error('é‡æ–°æ£€æŸ¥ç‰ˆæœ¬å¤±è´¥:', error);
            }
          }, 5000);

        } else {
          const error = await response.json();
          alert('âŒ æ›´æ–°å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('æ›´æ–°å¤±è´¥:', error);
        alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
      } finally {
        updateBtn.disabled = false;
        updateBtn.textContent = originalText;
      }
    }

    // æŸ¥çœ‹æ—¥å¿—
    function viewLogs() {
      window.open('/logs', '_blank');
    }

    // æ‰“å¼€GitHub
    function openGithub() {
      window.open('https://github.com/kis2show/lazybala', '_blank');
    }

    // åé¦ˆé—®é¢˜
    function reportIssue() {
      window.open('https://github.com/kis2show/lazybala/issues', '_blank');
    }

    // å†å²è®°å½•ç›¸å…³åŠŸèƒ½
    // åˆ·æ–°å†å²è®°å½•
    async function refreshHistory() {
      try {
        const response = await fetch('/api/download/history');
        if (response.ok) {
          const data = await response.json();
          downloadHistory = data.tasks || [];
          console.log('è·å–åˆ°å†å²è®°å½•:', downloadHistory);
          console.log('å·²å®Œæˆè®°å½•æ•°é‡:', downloadHistory.filter(item => item.status === 'completed').length);
          updateHistoryDisplay();
          updateDownloadStats();
        } else {
          // å¦‚æœAPIä¸å­˜åœ¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
          loadMockHistory();
        }
      } catch (error) {
        console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
        loadMockHistory();
      }
    }

    // åŠ è½½æ¨¡æ‹Ÿå†å²æ•°æ®
    function loadMockHistory() {
      downloadHistory = [
        {
          id: 1,
          title: 'ã€éŸ³ä¹ã€‘å¤œçš„é’¢ç´æ›²äº”',
          url: 'https://www.bilibili.com/video/BV1234567890',
          status: 'completed',
          progress: 100,
          created_at: '2024-01-15 14:30:00',
          file_size: '5.2MB',
          duration: '3:45'
        },
        {
          id: 2,
          title: 'ã€ASMRã€‘é›¨å£°ç™½å™ªéŸ³ - åŠ©çœ éŸ³é¢‘',
          url: 'https://www.bilibili.com/video/BV0987654321',
          status: 'completed',
          progress: 100,
          created_at: '2024-01-14 20:15:00',
          file_size: '12.8MB',
          duration: '8:20'
        },
        {
          id: 3,
          title: 'ã€æ•™ç¨‹ã€‘JavaScriptå…¥é—¨åˆ°ç²¾é€š',
          url: 'https://www.bilibili.com/video/BV1111111111',
          status: 'failed',
          progress: 45,
          created_at: '2024-01-13 16:45:00',
          file_size: '0MB',
          error: 'ç½‘ç»œè¿æ¥è¶…æ—¶'
        },
        {
          id: 4,
          title: 'ã€éŸ³ä¹ã€‘Lo-Fi Hip Hop Mix',
          url: 'https://www.bilibili.com/video/BV2222222222',
          status: 'downloading',
          progress: 78,
          created_at: '2024-01-15 15:20:00',
          file_size: '8.5MB',
          duration: '5:30'
        }
      ];
      updateHistoryDisplay();
      updateDownloadStats();
    }

    // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
    function updateHistoryDisplay() {
      const historyList = document.getElementById('historyList');
      const filteredHistory = filterHistoryData();

      if (filteredHistory.length === 0) {
        historyList.innerHTML = `
          <div class="setting-info" style="text-align: center; color: var(--text-secondary);">
            <span>ğŸ“</span>
            <div>æš‚æ— ${getFilterText()}è®°å½•</div>
          </div>
        `;
        return;
      }

      historyList.innerHTML = filteredHistory.map(item => createHistoryItem(item)).join('');
    }

    // ç­›é€‰å†å²æ•°æ®
    function filterHistoryData() {
      if (currentFilter === 'all') return downloadHistory;
      return downloadHistory.filter(item => {
        if (currentFilter === 'completed') return item.status === 'completed';
        if (currentFilter === 'failed') return item.status === 'failed';
        return false;
      });
    }

    // è·å–ç­›é€‰æ–‡æœ¬
    function getFilterText() {
      switch (currentFilter) {
        case 'completed': return 'å·²å®Œæˆ';
        case 'failed': return 'å¤±è´¥';
        default: return '';
      }
    }

    // åˆ›å»ºå†å²è®°å½•é¡¹
    function createHistoryItem(item) {
      const icon = getStatusIcon(item.status);
      const iconClass = getStatusClass(item.status);
      const timeAgo = getTimeAgo(item.created_at);

      return `
        <div class="history-item">
          <div class="history-icon ${iconClass}">
            ${icon}
          </div>
          <div class="history-content">
            <div class="history-title">${item.title}</div>
            <div class="history-meta">
              <span>${timeAgo}</span>
              <span>${item.file_size || 'æœªçŸ¥å¤§å°'}</span>
              ${item.duration ? `<span>${item.duration}</span>` : ''}
              ${item.error ? `<span style="color: #ff3b30;">é”™è¯¯: ${item.error}</span>` : ''}
            </div>
            ${item.status === 'downloading' ? `
              <div class="mini-progress">
                <div class="mini-progress-fill" style="width: ${item.progress}%"></div>
              </div>
            ` : ''}
          </div>
          <div class="history-actions">
            <button class="history-btn" onclick="copyUrl('${item.url}')">å¤åˆ¶é“¾æ¥</button>
            ${item.status === 'failed' ? '<button class="history-btn" onclick="retryDownload(' + item.id + ')">é‡è¯•</button>' : ''}
            <button class="history-btn" onclick="deleteHistoryItem(' + item.id + ')">åˆ é™¤</button>
          </div>
        </div>
      `;
    }

    // è·å–çŠ¶æ€å›¾æ ‡
    function getStatusIcon(status) {
      switch (status) {
        case 'completed': return 'âœ…';
        case 'failed': return 'âŒ';
        case 'downloading': return 'â¬‡ï¸';
        default: return 'ğŸ“„';
      }
    }

    // è·å–çŠ¶æ€æ ·å¼ç±»
    function getStatusClass(status) {
      switch (status) {
        case 'completed': return 'success';
        case 'failed': return 'error';
        case 'downloading': return 'warning';
        default: return '';
      }
    }

    // è·å–ç›¸å¯¹æ—¶é—´
    function getTimeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffMins < 1) return 'åˆšåˆš';
      if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
      if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
      if (diffDays < 7) return `${diffDays}å¤©å‰`;
      return date.toLocaleDateString();
    }

    // æ›´æ–°ä¸‹è½½ç»Ÿè®¡
    function updateDownloadStats() {
      const completed = downloadHistory.filter(item => item.status === 'completed').length;
      const failed = downloadHistory.filter(item => item.status === 'failed').length;
      const total = downloadHistory.length;

      document.getElementById('downloadStats').textContent =
        `æ€»è®¡: ${total} | æˆåŠŸ: ${completed} | å¤±è´¥: ${failed}`;
    }

    // ç­›é€‰å†å²è®°å½•
    function filterHistory(type) {
      currentFilter = type;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€ - é‡ç½®æ‰€æœ‰ç­›é€‰æŒ‰é’®
      const allButtons = ['filterAll', 'filterCompleted', 'filterFailed'];
      allButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.style.background = 'var(--bg-tertiary)';
          btn.style.color = 'var(--text-primary)';
        }
      });

      // æ¿€æ´»é€‰ä¸­çš„æŒ‰é’®
      const activeBtn = document.getElementById('filter' + type.charAt(0).toUpperCase() + type.slice(1));
      if (activeBtn) {
        activeBtn.style.background = 'var(--accent-color)';
        activeBtn.style.color = 'white';
      }

      updateHistoryDisplay();
    }

    // å¤åˆ¶é“¾æ¥
    function copyUrl(url) {
      navigator.clipboard.writeText(url).then(() => {
        alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      }).catch(() => {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶: ' + url);
      });
    }

    // æ‰“å¼€æ–‡ä»¶
    function openFile(id) {
      alert('æ‰“å¼€æ–‡ä»¶åŠŸèƒ½å¼€å‘ä¸­...');
    }

    // é‡è¯•ä¸‹è½½
    function retryDownload(id) {
      const item = downloadHistory.find(h => h.id === id);
      if (item) {
        document.getElementById('urlInput').value = item.url;
        hideSettings();
        alert('å·²å¡«å…¥é“¾æ¥ï¼Œè¯·ç‚¹å‡»æ£€æŸ¥åˆ—è¡¨é‡æ–°ä¸‹è½½');
      }
    }

    // åˆ é™¤å†å²è®°å½•é¡¹
    function deleteHistoryItem(id) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        downloadHistory = downloadHistory.filter(item => item.id !== id);
        updateHistoryDisplay();
        updateDownloadStats();
      }
    }

    // æ¸…ç©ºå†å²è®°å½•
    function clearHistory() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        downloadHistory = [];
        updateHistoryDisplay();
        updateDownloadStats();
        alert('å†å²è®°å½•å·²æ¸…ç©º');
      }
    }

    // å¯¼å‡ºå†å²è®°å½•
    function exportHistory() {
      const data = JSON.stringify(downloadHistory, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lazybala_history_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // æ‰“å¼€ä¸‹è½½ç›®å½•
    function openDownloadFolder() {
      alert('æ‰“å¼€ä¸‹è½½ç›®å½•åŠŸèƒ½éœ€è¦ç³»ç»Ÿæ”¯æŒ');
    }

    // æµ‹è¯•æ£€æŸ¥åŠŸèƒ½
    async function testCheck() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) {
        alert('è¯·è¾“å…¥é“¾æ¥');
        return;
      }

      console.log('æ£€æŸ¥é“¾æ¥:', url);

      // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const checkBtn = document.querySelector('button[onclick="testCheck()"]');
      const originalText = checkBtn.textContent;
      checkBtn.disabled = true;
      checkBtn.textContent = 'æ£€æŸ¥ä¸­...';

      try {
        const response = await fetch('/api/download/precheck', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: url })
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById('resultText').textContent = `${result.title} - å…±${result.audio_count}é›†`;
          document.getElementById('resultBox').style.display = 'block';

          // æ›´æ–°æŒ‰é’®æ–‡æœ¬ä¸º"ç¡®è®¤ä¸‹è½½"
          const downloadBtn = document.querySelector('#resultBox button[onclick="testDownload()"]');
          if (downloadBtn) {
            downloadBtn.textContent = 'ç¡®è®¤ä¸‹è½½';
          }
        } else {
          const error = await response.json();
          alert('æ£€æŸ¥å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('æ£€æŸ¥å¤±è´¥:', error);
        alert('æ£€æŸ¥å¤±è´¥: ' + error.message);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        checkBtn.disabled = false;
        checkBtn.textContent = originalText;
      }
    }

    // å¿«æ·é”®å¤„ç†æ£€æŸ¥åˆ—è¡¨
    function handleCheckList() {
      testCheck();
    }

    // æµ‹è¯•ä¸‹è½½åŠŸèƒ½
    async function testDownload() {
      const url = document.getElementById('urlInput').value.trim();
      const path = document.getElementById('pathInput').value.trim() || 'test';

      // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const downloadBtn = document.querySelector('#resultBox button[onclick="testDownload()"]');
      const originalText = downloadBtn.textContent;
      downloadBtn.disabled = true;
      downloadBtn.textContent = 'å¯åŠ¨ä¸­...';

      try {
        // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„ä¸‹è½½ä»»åŠ¡
        const statusResponse = await fetch('/api/download/status');
        if (statusResponse.ok) {
          const status = await statusResponse.json();
          if (status.isDownloading) {
            // å¦‚æœæœ‰æ´»è·ƒä¸‹è½½ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦åœæ­¢
            if (confirm('æ£€æµ‹åˆ°æœ‰æ­£åœ¨è¿›è¡Œçš„ä¸‹è½½ä»»åŠ¡ï¼Œæ˜¯å¦åœæ­¢å½“å‰ä»»åŠ¡å¹¶å¼€å§‹æ–°çš„ä¸‹è½½ï¼Ÿ')) {
              downloadBtn.textContent = 'åœæ­¢ä¸­...';
              await fetch('/api/download/stop', { method: 'POST' });
              // ç­‰å¾…2ç§’ç¡®ä¿ä»»åŠ¡å®Œå…¨åœæ­¢
              await new Promise(resolve => setTimeout(resolve, 2000));
              downloadBtn.textContent = 'å¯åŠ¨ä¸­...';
            } else {
              downloadBtn.disabled = false;
              downloadBtn.textContent = originalText;
              return;
            }
          }
        }

        // è·å–å½“å‰è®¾ç½®
        const configResponse = await fetch('/api/config');
        let config = {};
        if (configResponse.ok) {
          config = await configResponse.json();
        }

        const response = await fetch('/api/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url: url,
            save_path: path,
            title_regex: config.title_regex || '%(title)s.%(ext)s',
            quality: config.quality || 'bestaudio/best',
            retry_count: config.retry_count || 5,
            write_thumbnail: config.write_thumbnail !== false
          })
        });

        if (response.ok) {
          document.getElementById('progressBox').style.display = 'block';
          document.getElementById('resultBox').style.display = 'none';

          // é‡ç½®è¿›åº¦æ˜¾ç¤º
          document.getElementById('progressBar').style.width = '0%';
          document.getElementById('progressText').textContent = 'å‡†å¤‡ä¸‹è½½...';

          // ç¡®ä¿WebSocketè¿æ¥
          if (!isConnected) {
            connectWebSocket();
          }
        } else {
          const error = await response.json();

          // å¦‚æœä»ç„¶æœ‰å†²çªï¼Œæä¾›æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
          if (response.status === 409) {
            if (confirm('ä»æœ‰ä¸‹è½½ä»»åŠ¡åœ¨è¿è¡Œï¼Œæ˜¯å¦å¼ºåˆ¶åœæ­¢å¹¶é‡è¯•ï¼Ÿ')) {
              await fetch('/api/download/stop', { method: 'POST' });
              await new Promise(resolve => setTimeout(resolve, 3000));
              // é€’å½’é‡è¯•
              downloadBtn.disabled = false;
              downloadBtn.textContent = originalText;
              return testDownload();
            }
          } else {
            alert('ä¸‹è½½å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
          }

          // æ¢å¤æŒ‰é’®çŠ¶æ€
          downloadBtn.disabled = false;
          downloadBtn.textContent = originalText;
        }
      } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        alert('ä¸‹è½½å¤±è´¥: ' + error.message);
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        downloadBtn.disabled = false;
        downloadBtn.textContent = originalText;
      }
    }

    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
    function startProgressUpdate() {
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          document.getElementById('progressText').textContent = 'ä¸‹è½½å®Œæˆï¼';
        }

        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = `ä¸‹è½½è¿›åº¦: ${Math.round(progress)}%`;
      }, 500);
    }

    // éšè—ç»“æœ
    function hideResult() {
      document.getElementById('resultBox').style.display = 'none';
    }

    // åœæ­¢ä¸‹è½½
    async function stopDownload() {
      const stopBtn = document.querySelector('button[onclick="stopDownload()"]');

      // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å·²ç¦ç”¨ï¼ˆä¸‹è½½å®ŒæˆçŠ¶æ€ï¼‰
      if (stopBtn.disabled) {
        return;
      }

      if (!confirm('ç¡®å®šè¦åœæ­¢å½“å‰ä¸‹è½½å—ï¼Ÿ')) {
        return;
      }

      const originalText = stopBtn.textContent;
      stopBtn.disabled = true;
      stopBtn.textContent = 'åœæ­¢ä¸­...';

      try {
        const response = await fetch('/api/download/stop', { method: 'POST' });

        if (response.ok) {
          // æ›´æ–°UIçŠ¶æ€
          document.getElementById('progressText').textContent = 'ä¸‹è½½å·²åœæ­¢';

          // æ›´æ–°é˜¶æ®µçŠ¶æ€
          const phaseEl = document.getElementById('downloadPhase');
          if (phaseEl) {
            phaseEl.textContent = 'å·²åœæ­¢';
            phaseEl.className = 'download-phase error';
          }

          // 3ç§’åéšè—è¿›åº¦æ¡†
          setTimeout(() => {
            document.getElementById('progressBox').style.display = 'none';
          }, 3000);
        } else {
          alert('åœæ­¢ä¸‹è½½å¤±è´¥');
          stopBtn.disabled = false;
          stopBtn.textContent = originalText;
        }
      } catch (error) {
        console.error('åœæ­¢ä¸‹è½½å¤±è´¥:', error);
        alert('åœæ­¢ä¸‹è½½å¤±è´¥: ' + error.message);
        stopBtn.disabled = false;
        stopBtn.textContent = originalText;
      }
    }



    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
      const statusMap = {
        'completed': 'å·²å®Œæˆ',
        'failed': 'å¤±è´¥',
        'downloading': 'ä¸‹è½½ä¸­',
        'stopped': 'å·²åœæ­¢',
        'pending': 'ç­‰å¾…ä¸­',
        'paused': 'å·²æš‚åœ'
      };
      return statusMap[status] || status;
    }

    // æš‚åœ/æ¢å¤ä¸‹è½½
    async function pauseResumeDownload() {
      const pauseBtn = document.getElementById('pauseResumeBtn');
      const isPaused = pauseBtn.textContent.includes('æ¢å¤');
      const action = isPaused ? 'resume' : 'pause';

      const originalText = pauseBtn.textContent;
      pauseBtn.disabled = true;
      pauseBtn.textContent = isPaused ? 'æ¢å¤ä¸­...' : 'æš‚åœä¸­...';

      try {
        const response = await fetch(`/api/download/${action}`, { method: 'POST' });

        if (response.ok) {
          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          pauseBtn.textContent = isPaused ? 'æš‚åœä¸‹è½½' : 'æ¢å¤ä¸‹è½½';

          // æ›´æ–°è¿›åº¦æ–‡æœ¬
          const progressText = document.getElementById('progressText');
          if (progressText) {
            if (isPaused) {
              progressText.textContent = progressText.textContent.replace('å·²æš‚åœ', 'ä¸‹è½½ä¸­');
            } else {
              progressText.textContent = progressText.textContent + ' (å·²æš‚åœ)';
            }
          }

          // æ›´æ–°é˜¶æ®µçŠ¶æ€
          const phaseEl = document.getElementById('downloadPhase');
          if (phaseEl) {
            if (isPaused) {
              phaseEl.textContent = 'ä¸‹è½½ä¸­';
              phaseEl.className = 'download-phase downloading';
            } else {
              phaseEl.textContent = 'å·²æš‚åœ';
              phaseEl.className = 'download-phase warning';
            }
          }
        } else {
          alert(`${isPaused ? 'æ¢å¤' : 'æš‚åœ'}ä¸‹è½½å¤±è´¥`);
          pauseBtn.textContent = originalText;
        }
      } catch (error) {
        console.error(`${action}ä¸‹è½½å¤±è´¥:`, error);
        alert(`${isPaused ? 'æ¢å¤' : 'æš‚åœ'}ä¸‹è½½å¤±è´¥: ` + error.message);
        pauseBtn.textContent = originalText;
      } finally {
        pauseBtn.disabled = false;
      }
    }

    // é‡æ–°ä¸‹è½½
    async function restartDownload() {
      if (!confirm('ç¡®å®šè¦é‡æ–°ä¸‹è½½å½“å‰é¡¹ç›®å—ï¼Ÿ\nè¿™å°†æ¸…é™¤å½“å‰è¿›åº¦å¹¶é‡æ–°å¼€å§‹ã€‚')) {
        return;
      }

      const restartBtn = document.getElementById('restartBtn');
      const originalText = restartBtn.textContent;
      restartBtn.disabled = true;
      restartBtn.textContent = 'é‡å¯ä¸­...';

      try {
        // å…ˆåœæ­¢å½“å‰ä¸‹è½½
        await fetch('/api/download/stop', { method: 'POST' });

        // ç­‰å¾…ä¸€ç§’åé‡æ–°å¼€å§‹
        setTimeout(async () => {
          try {
            await testDownload();
            restartBtn.style.display = 'none';
          } catch (error) {
            console.error('é‡æ–°ä¸‹è½½å¤±è´¥:', error);
            alert('é‡æ–°ä¸‹è½½å¤±è´¥: ' + error.message);
            restartBtn.disabled = false;
            restartBtn.textContent = originalText;
          }
        }, 1000);
      } catch (error) {
        console.error('é‡æ–°ä¸‹è½½å¤±è´¥:', error);
        alert('é‡æ–°ä¸‹è½½å¤±è´¥: ' + error.message);
        restartBtn.disabled = false;
        restartBtn.textContent = originalText;
      }
    }

    // WebSocketè¿æ¥å’Œè¿›åº¦æ›´æ–°
    let ws = null;
    let isConnected = false;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    // ç”Ÿäº§ç¯å¢ƒé…ç½®
    const appConfig = {
      wsUrl: `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`,
      apiBase: '/api',
      reconnectInterval: 3000,
      heartbeatInterval: 30000,
      version: '1.0.0'
    };

    function connectWebSocket() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        console.log('WebSocketå·²è¿æ¥');
        return;
      }

      console.log('è¿æ¥WebSocket:', appConfig.wsUrl);

      ws = new WebSocket(appConfig.wsUrl);

      ws.onopen = function() {
        console.log('WebSocketè¿æ¥æˆåŠŸ');
        isConnected = true;
        reconnectAttempts = 0; // é‡ç½®é‡è¿è®¡æ•°
        updateConnectionStatus(true);
      };

      ws.onmessage = function(event) {
        console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', event.data);
        try {
          const message = JSON.parse(event.data);
          if (message.type === 'progress') {
            updateProgressDisplay(message.data);
          }
        } catch (e) {
          console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', e);
        }
      };

      ws.onclose = function() {
        console.log('WebSocketè¿æ¥å…³é—­');
        isConnected = false;
        updateConnectionStatus(false);

        // æ™ºèƒ½é‡è¿æœºåˆ¶
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          const delay = Math.min(appConfig.reconnectInterval * reconnectAttempts, 30000);
          console.log(`${delay}msåå°è¯•ç¬¬${reconnectAttempts}æ¬¡é‡è¿`);
          setTimeout(connectWebSocket, delay);
        } else {
          console.log('è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
        }
      };

      ws.onerror = function(error) {
        console.error('WebSocketé”™è¯¯:', error);
        isConnected = false;
        updateConnectionStatus(false);
      };
    }

    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('wsStatus');
      if (statusEl) {
        statusEl.textContent = connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
        statusEl.className = connected ? 'ws-status connected' : 'ws-status disconnected';
      }
    }

    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
    function updateProgressDisplay(progress) {
      console.log('æ›´æ–°è¿›åº¦æ˜¾ç¤º:', progress);

      // æ˜¾ç¤ºè¿›åº¦æ¡†
      document.getElementById('progressBox').style.display = 'block';

      // æ£€æŸ¥ä¸‹è½½æ˜¯å¦å®Œæˆ
      const isCompleted = progress.phase === 'completed' || (!progress.isDownloading && progress.progress >= 100);

      // æ›´æ–°åœæ­¢ä¸‹è½½æŒ‰é’®çŠ¶æ€
      const stopButton = document.querySelector('button[onclick="stopDownload()"]');
      if (stopButton) {
        stopButton.disabled = isCompleted;
        stopButton.style.opacity = isCompleted ? '0.5' : '1';
        stopButton.style.cursor = isCompleted ? 'not-allowed' : 'pointer';
      }

      // æ›´æ–°æš‚åœ/æ¢å¤æŒ‰é’®çŠ¶æ€
      const pauseButton = document.getElementById('pauseResumeBtn');
      if (pauseButton) {
        if (progress.isDownloading && !isCompleted) {
          pauseButton.style.display = 'inline-block';
          pauseButton.disabled = false;

          // æ ¹æ®æš‚åœçŠ¶æ€æ›´æ–°æŒ‰é’®æ–‡æœ¬
          if (progress.isPaused) {
            pauseButton.textContent = 'æ¢å¤ä¸‹è½½';
          } else {
            pauseButton.textContent = 'æš‚åœä¸‹è½½';
          }
        } else {
          pauseButton.style.display = 'none';
        }
      }

      // æ›´æ–°é‡æ–°ä¸‹è½½æŒ‰é’®çŠ¶æ€
      const restartButton = document.getElementById('restartBtn');
      if (restartButton) {
        if (isCompleted || (!progress.isDownloading && progress.progress > 0)) {
          restartButton.style.display = 'inline-block';
          restartButton.disabled = false;
        } else {
          restartButton.style.display = 'none';
        }
      }

      // å¦‚æœä¸‹è½½å®Œæˆä¸”ä¸å†ä¸‹è½½ä¸­ï¼Œä¿æŒæ˜¾ç¤ºä½†ç¦ç”¨æ§åˆ¶
      if (!progress.isDownloading && isCompleted) {
        console.log('ä¸‹è½½å·²å®Œæˆï¼Œä¿æŒæ˜¾ç¤ºè¿›åº¦æ¡†');
        // ä¸éšè—è¿›åº¦æ¡†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®ŒæˆçŠ¶æ€
      }

      // æ›´æ–°åŸºæœ¬è¿›åº¦ä¿¡æ¯
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const statusText = document.getElementById('statusText');

      if (progressBar) {
        progressBar.style.width = `${progress.progress || 0}%`;
      }

      if (progressText) {
        progressText.textContent = `${(progress.progress || 0).toFixed(1)}%`;
      }

      if (statusText) {
        statusText.textContent = progress.status || 'ä¸‹è½½ä¸­...';
      }

      // æ›´æ–°è¯¦ç»†ä¿¡æ¯
      updateDetailedProgress(progress);
    }

    // æ›´æ–°è¯¦ç»†è¿›åº¦ä¿¡æ¯
    function updateDetailedProgress(progress) {
      // æ›´æ–°å½“å‰æ–‡ä»¶ä¿¡æ¯
      const currentFileEl = document.getElementById('currentFile');
      if (currentFileEl && progress.currentTitle) {
        currentFileEl.textContent = `å½“å‰: ${progress.currentTitle}`;
      }

      // æ›´æ–°æ’­æ”¾åˆ—è¡¨è¿›åº¦
      const playlistProgressEl = document.getElementById('playlistProgress');
      if (playlistProgressEl && progress.totalCount > 0) {
        let progressText = `é¡¹ç›®: ${progress.currentIndex || 0}/${progress.totalCount}`;
        if (progress.fileProgress !== undefined && progress.fileProgress !== progress.progress) {
          progressText += ` (å½“å‰æ–‡ä»¶: ${progress.fileProgress.toFixed(1)}%)`;
        }
        playlistProgressEl.textContent = progressText;
        playlistProgressEl.style.display = 'block';
      } else if (playlistProgressEl) {
        playlistProgressEl.style.display = 'none';
      }

      // æ›´æ–°é€Ÿåº¦å’ŒETA
      const speedEl = document.getElementById('downloadSpeed');
      if (speedEl && progress.speed) {
        speedEl.textContent = `é€Ÿåº¦: ${progress.speed}`;
        speedEl.style.display = 'block';
      } else if (speedEl) {
        speedEl.style.display = 'none';
      }

      const etaEl = document.getElementById('downloadETA');
      if (etaEl && progress.eta) {
        etaEl.textContent = `å‰©ä½™: ${progress.eta}`;
        etaEl.style.display = 'block';
      } else if (etaEl) {
        etaEl.style.display = 'none';
      }

      // æ›´æ–°æ–‡ä»¶å¤§å°
      const fileSizeEl = document.getElementById('fileSize');
      if (fileSizeEl && progress.fileSize) {
        fileSizeEl.textContent = `å¤§å°: ${progress.fileSize}`;
        fileSizeEl.style.display = 'block';
      } else if (fileSizeEl) {
        fileSizeEl.style.display = 'none';
      }

      // æ›´æ–°é˜¶æ®µä¿¡æ¯
      const phaseEl = document.getElementById('downloadPhase');
      if (phaseEl && progress.phase) {
        const phaseText = getPhaseText(progress.phase);
        phaseEl.textContent = phaseText;
        phaseEl.className = `download-phase ${progress.phase}`;
      }

      // æ›´æ–°å…ƒæ•°æ®ä¿¡æ¯
      updateMetadataDisplay(progress);

      // æ›´æ–°å·²å®Œæˆæ–‡ä»¶åˆ—è¡¨
      updateCompletedFiles(progress.completedFiles);
    }

    // è·å–é˜¶æ®µæ–‡æœ¬
    function getPhaseText(phase) {
      const phaseMap = {
        'initializing': 'åˆå§‹åŒ–ä¸­',
        'extracting': 'æå–ä¿¡æ¯ä¸­',
        'downloading': 'ä¸‹è½½ä¸­',
        'merging': 'åˆå¹¶ä¸­',
        'completed': 'å·²å®Œæˆ',
        'error': 'å‡ºç°é”™è¯¯'
      };
      return phaseMap[phase] || phase;
    }

    // æ›´æ–°å…ƒæ•°æ®æ˜¾ç¤º
    function updateMetadataDisplay(progress) {
      const metadataEl = document.getElementById('metadata');
      if (!metadataEl) return;

      let metadataHtml = '';

      if (progress.duration) {
        metadataHtml += `<div class="metadata-item">â±ï¸ æ—¶é•¿: ${progress.duration}</div>`;
      }

      if (progress.uploader) {
        metadataHtml += `<div class="metadata-item">ğŸ‘¤ ä¸Šä¼ è€…: ${progress.uploader}</div>`;
      }

      if (progress.viewCount) {
        metadataHtml += `<div class="metadata-item">ğŸ‘ï¸ æ’­æ”¾é‡: ${progress.viewCount}</div>`;
      }

      if (progress.playlistTitle) {
        metadataHtml += `<div class="metadata-item">ğŸ“‹ æ’­æ”¾åˆ—è¡¨: ${progress.playlistTitle}</div>`;
      }

      metadataEl.innerHTML = metadataHtml;
      metadataEl.style.display = metadataHtml ? 'block' : 'none';
    }

    // æ›´æ–°å·²å®Œæˆæ–‡ä»¶åˆ—è¡¨
    function updateCompletedFiles(completedFiles) {
      const completedEl = document.getElementById('completedFiles');
      if (!completedEl || !completedFiles || completedFiles.length === 0) {
        if (completedEl) completedEl.style.display = 'none';
        return;
      }

      const filesHtml = completedFiles.map(file =>
        `<div class="completed-file">âœ… ${file}</div>`
      ).join('');

      completedEl.innerHTML = `<div class="completed-title">å·²å®Œæˆ:</div>${filesHtml}`;
      completedEl.style.display = 'block';
    }

    // é¡µé¢åŠ è½½æ—¶è¿æ¥WebSocket
    document.addEventListener('DOMContentLoaded', function() {
      try {
        console.log(`LazyBala v${appConfig.version} åˆå§‹åŒ–ä¸­...`);

        // åˆå§‹åŒ–ä¸»é¢˜
        initTheme();

        // è¿æ¥WebSocket
        connectWebSocket();

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        checkSystemStatus();

        // è®¾ç½®é”®ç›˜å¿«æ·é”®
        setupKeyboardShortcuts();

        // è®¾ç½®é¡µé¢å¯è§æ€§æ£€æµ‹
        setupVisibilityChange();

        // åŠ è½½é…ç½®å’Œå†å²è®°å½•
        refreshHistory();
        updateDownloadStats();

        // åˆå§‹åŒ–ç‰ˆæœ¬ä¿¡æ¯
        initVersionInfo();

        console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
      } catch (error) {
        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    });

    // åˆå§‹åŒ–ç‰ˆæœ¬ä¿¡æ¯
    async function initVersionInfo() {
      try {
        const response = await fetch('/api/version/check');
        if (response.ok) {
          const data = await response.json();
          const versionText = document.getElementById('versionText');
          if (versionText) {
            versionText.textContent = `LazyBala: ${data.app.current} | yt-dlp: ${data.ytdlp.current}`;
          }
        }
      } catch (error) {
        console.error('è·å–ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // è®¾ç½®é¡µé¢å¯è§æ€§æ£€æµ‹
    function setupVisibilityChange() {
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          console.log('é¡µé¢éšè—');
        } else {
          console.log('é¡µé¢æ˜¾ç¤ºï¼Œæ£€æŸ¥WebSocketè¿æ¥');
          if (!isConnected) {
            connectWebSocket();
          }
        }
      });
    }

    // å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', function(e) {
      console.error('å…¨å±€é”™è¯¯:', e.error);
    });

    window.addEventListener('unhandledrejection', function(e) {
      console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
      e.preventDefault(); // é˜²æ­¢é”™è¯¯æ˜¾ç¤ºåœ¨æ§åˆ¶å°
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LazyBala - Ë¥πÂä≤Â∑¥Êãâ‰∏ãËΩΩÂô®</title>
  <meta name="description" content="LazyBala - Èùû‰∏ì‰∏öÁöÑÂ•óÂ£≥‰∏ãËΩΩÂ∑•ÂÖ∑ÔºåÊîØÊåÅÂìîÂì©ÂìîÂì©ÊúâÂ£∞Èü≥È¢ë‰∏ãËΩΩ">
  <meta name="keywords" content="‰∏ãËΩΩÂ∑•ÂÖ∑,ÊúâÂ£∞Èü≥È¢ë‰∏ãËΩΩÂô®">
  <meta name="author" content="Kis2Show">
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶´</text></svg>">
  <style>
    :root {
      --bg-primary: #1c1c1e;
      --bg-secondary: #2c2c2e;
      --bg-tertiary: #3a3a3c;
      --text-primary: #ffffff;
      --text-secondary: #8e8e93;
      --border-color: #48484a;
      --primary-color: #ff6b35;
      --primary-hover: #e55a2b;
    }

    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f2f2f7;
      --bg-tertiary: #e5e5ea;
      --text-primary: #000000;
      --text-secondary: #6d6d70;
      --border-color: #c6c6c8;
      --primary-color: #ff6b35;
      --primary-hover: #e55a2b;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin: 0;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .header {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-center {
      flex: 1;
      text-align: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .theme-toggle {
      background: var(--bg-tertiary);
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: var(--border-color);
    }

    .settings-btn {
      background: var(--bg-tertiary);
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      background: var(--border-color);
    }

    .input-box {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .input-field {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 16px;
      margin-bottom: 10px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .input-hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .button-group {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 20px;
    }

    .shortcut-hint {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--primary-hover);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    /* ËÆæÁΩÆÂºπÁ™ó */
    .settings-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .settings-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-content {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .settings-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      color: var(--text-primary);
    }

    .setting-group {
      margin-bottom: 20px;
    }

    .setting-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .setting-desc {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .setting-switch {
      position: relative;
      width: 50px;
      height: 28px;
      background: var(--bg-tertiary);
      border-radius: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .setting-switch.active {
      background: var(--primary-color);
    }

    .setting-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .setting-switch.active::after {
      transform: translateX(22px);
    }

    .setting-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .setting-info.success {
      background: rgba(52, 199, 89, 0.1);
      border: 1px solid rgba(52, 199, 89, 0.3);
    }

    .setting-info.warning {
      background: rgba(255, 149, 0, 0.1);
      border: 1px solid rgba(255, 149, 0, 0.3);
    }

    .setting-info.error {
      background: rgba(255, 59, 48, 0.1);
      border: 1px solid rgba(255, 59, 48, 0.3);
    }

    .setting-tabs {
      display: flex;
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 20px;
    }

    .setting-tab {
      flex: 1;
      padding: 8px 12px;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .setting-tab.active {
      background: var(--primary-color);
      color: white;
    }

    .setting-content {
      display: none;
    }

    .setting-content.active {
      display: block;
    }

    .login-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    .status-dot.online {
      background: #34c759;
    }

    .status-dot.offline {
      background: #ff3b30;
    }

    .qr-container {
      text-align: center;
      padding: 20px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .qr-code {
      width: 200px;
      height: 200px;
      margin: 0 auto 15px;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn-group .btn {
      flex: 1;
      margin-right: 0;
    }

    /* ÂéÜÂè≤ËÆ∞ÂΩïÊ†∑Âºè */
    .history-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }

    .history-item:hover {
      background: var(--border-color);
    }

    .history-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 18px;
    }

    .history-icon.success {
      background: #34c759;
    }

    .history-icon.error {
      background: #ff3b30;
    }

    .history-icon.warning {
      background: #ff9500;
    }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-title {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-meta {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      gap: 12px;
    }

    .history-actions {
      display: flex;
      gap: 8px;
    }

    .history-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      background: var(--bg-primary);
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .history-btn:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    /* ËøõÂ∫¶Êù°Ê†∑Âºè */
    .mini-progress {
      width: 60px;
      height: 4px;
      background: var(--bg-primary);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }

    .mini-progress-fill {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.3s;
    }

    /* ÈîÆÁõòÊåâÈîÆÊ†∑Âºè */
    kbd {
      display: inline-block;
      padding: 2px 6px;
      font-size: 11px;
      line-height: 1.4;
      color: var(--text-primary);
      background-color: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      box-shadow: 0 1px 0 var(--border-color);
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-weight: 500;
    }

    /* Â¢ûÂº∫ÁöÑËøõÂ∫¶ÊòæÁ§∫Ê†∑Âºè */
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .progress-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .progress-title h3 {
      margin: 0;
      font-size: 18px;
    }

    .progress-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .download-phase {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .download-phase.initializing {
      background: #007aff;
      color: white;
    }

    .download-phase.extracting {
      background: #ff9500;
      color: white;
    }

    .download-phase.downloading {
      background: #34c759;
      color: white;
    }

    .download-phase.merging {
      background: #af52de;
      color: white;
    }

    .download-phase.completed {
      background: #30d158;
      color: white;
    }

    .download-phase.error {
      background: #ff3b30;
      color: white;
    }

    .ws-status {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .ws-status.connected {
      background: #30d158;
      color: white;
    }

    .ws-status.disconnected {
      background: #8e8e93;
      color: white;
    }

    .progress-details {
      margin-top: 15px;
    }

    .progress-detail-item {
      margin: 8px 0;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .progress-stats {
      display: flex;
      gap: 15px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .progress-stat {
      padding: 4px 8px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .metadata-container {
      margin: 15px 0;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid var(--primary-color);
    }

    .metadata-item {
      margin: 6px 0;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .completed-files {
      margin: 15px 0;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid #30d158;
      max-height: 120px;
      overflow-y: auto;
    }

    .completed-title {
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .completed-file {
      margin: 4px 0;
      font-size: 12px;
      color: var(--text-secondary);
      padding: 2px 0;
    }

    /* ‰ΩøÁî®ËØ¥ÊòéÊ†∑Âºè */
    .usage-tips {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .tip-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 15px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid var(--primary-color);
    }

    .tip-icon {
      font-size: 20px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .tip-content {
      flex: 1;
    }

    .tip-content strong {
      color: var(--text-primary);
      display: block;
      margin-bottom: 8px;
    }

    .tip-content ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
      color: var(--text-secondary);
    }

    .tip-content li {
      margin: 4px 0;
      font-size: 13px;
      line-height: 1.4;
    }

    .tip-content p {
      margin: 4px 0;
      color: var(--text-secondary);
      font-size: 13px;
      line-height: 1.4;
    }

    .tip-content code {
      background: var(--bg-primary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 12px;
      color: var(--primary-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
      </div>
      <div class="header-center">
        <h1>LazyBala</h1>
        <p>Ë¥πÂä≤Â∑¥Êãâ‰∏ãËΩΩÂô®</p>
      </div>
      <div class="header-right">
        <button class="settings-btn" onclick="showSettings()">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="input-box">
      <h3>üì• ËæìÂÖ•‰∏ãËΩΩ‰ø°ÊÅØ</h3>

      <div class="input-group">
        <label class="input-label">üîó ËßÜÈ¢ëÈìæÊé•</label>
        <input type="text" class="input-field" placeholder="ËØ∑ËæìÂÖ•ÂìîÂì©ÂìîÂì©ËßÜÈ¢ëÈìæÊé•ÔºåÂ¶ÇÔºöhttps://www.bilibili.com/video/BV1YeXDYTELy" id="urlInput">
        <div class="input-hint">
          ÊîØÊåÅÂçï‰∏™ËßÜÈ¢ë„ÄÅÊí≠ÊîæÂàóË°®„ÄÅÂêàÈõÜÁ≠âÂ§öÁßçÈìæÊé•Ê†ºÂºè
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">üìÅ ‰øùÂ≠òË∑ØÂæÑ</label>
        <input type="text" class="input-field" placeholder="Êñá‰ª∂‰øùÂ≠òÁöÑÂ≠êÁõÆÂΩïÂêçÁß∞ÔºåÂ¶ÇÔºötest„ÄÅÈü≥‰πê„ÄÅÊïôÁ®ãÁ≠â" value="test" id="pathInput">
        <div class="input-hint">
          Êñá‰ª∂Â∞Ü‰øùÂ≠òÂà∞ audiobooks/[ÊÇ®ËæìÂÖ•ÁöÑË∑ØÂæÑ]/ ÁõÆÂΩï‰∏ã
        </div>
      </div>

      <div class="button-group">
        <button class="btn" onclick="testCheck()">üîç Ê£ÄÊü•ÂàóË°®</button>
        <div class="shortcut-hint">
          Âø´Êç∑ÈîÆÔºö<kbd>Ctrl</kbd> + <kbd>Enter</kbd>
        </div>
      </div>
    </div>

    <div class="input-box" id="resultBox" style="display: none;">
      <h3>Ê£ÄÊü•ÁªìÊûú</h3>
      <p id="resultText">Á≠âÂæÖÊ£ÄÊü•...</p>
      <button class="btn" onclick="testDownload()">ÂºÄÂßã‰∏ãËΩΩ</button>
      <button class="btn btn-secondary" onclick="hideResult()">ÂèñÊ∂à</button>
    </div>

    <div class="input-box" id="progressBox" style="display: none;">
      <div class="progress-header">
        <div class="progress-title">
          <h3>‰∏ãËΩΩËøõÂ∫¶</h3>
          <span id="downloadPhase" class="download-phase"></span>
        </div>
        <div class="progress-controls">
          <span id="wsStatus" class="ws-status">Êú™ËøûÊé•</span>
          <button class="btn btn-secondary" onclick="pauseResumeDownload()" id="pauseResumeBtn" style="display: none;">ÊöÇÂÅú‰∏ãËΩΩ</button>
          <button class="btn btn-secondary" onclick="stopDownload()">ÂÅúÊ≠¢‰∏ãËΩΩ</button>
          <button class="btn" onclick="restartDownload()" id="restartBtn" style="display: none;">ÈáçÊñ∞‰∏ãËΩΩ</button>
        </div>
      </div>

      <div style="background: #3a3a3c; height: 10px; border-radius: 5px; margin: 10px 0;">
        <div id="progressBar" style="background: #ff6b35; height: 100%; width: 0%; border-radius: 5px; transition: width 0.3s;"></div>
      </div>

      <div class="progress-details">
        <p id="progressText">ÂáÜÂ§á‰∏ãËΩΩ...</p>
        <div id="currentFile" class="progress-detail-item"></div>
        <div id="playlistProgress" class="progress-detail-item" style="display: none;"></div>

        <div class="progress-stats">
          <div id="downloadSpeed" class="progress-stat" style="display: none;"></div>
          <div id="downloadETA" class="progress-stat" style="display: none;"></div>
          <div id="fileSize" class="progress-stat" style="display: none;"></div>
        </div>
      </div>

      <!-- ÂÖÉÊï∞ÊçÆ‰ø°ÊÅØ -->
      <div id="metadata" class="metadata-container" style="display: none;"></div>

      <!-- Â∑≤ÂÆåÊàêÊñá‰ª∂ -->
      <div id="completedFiles" class="completed-files" style="display: none;"></div>
    </div>

    <!-- ‰ΩøÁî®ËØ¥Êòé -->
    <div class="input-box" style="margin-top: 30px;">
      <h3>üìñ ‰ΩøÁî®ËØ¥Êòé</h3>
      <div class="usage-tips">
        <div class="tip-item">
          <span class="tip-icon">üîó</span>
          <div class="tip-content">
            <strong>ÊîØÊåÅÁöÑÈìæÊé•Ê†ºÂºèÔºö</strong>
            <ul>
              <li>Âçï‰∏™ËßÜÈ¢ëÔºöhttps://www.bilibili.com/video/BV1234567890</li>
              <li>Êí≠ÊîæÂàóË°®Ôºöhttps://www.bilibili.com/playlist?list=...</li>
              <li>ÂêàÈõÜÔºöhttps://space.bilibili.com/uid/channel/collectiondetail?sid=...</li>
              <li>UP‰∏ªÁ©∫Èó¥Ôºöhttps://space.bilibili.com/uid</li>
            </ul>
          </div>
        </div>

        <div class="tip-item">
          <span class="tip-icon">üìÅ</span>
          <div class="tip-content">
            <strong>‰øùÂ≠òË∑ØÂæÑËØ¥ÊòéÔºö</strong>
            <p>Êñá‰ª∂Â∞Ü‰øùÂ≠òÂà∞ <code>audiobooks/[ÊÇ®ËæìÂÖ•ÁöÑË∑ØÂæÑ]/</code> ÁõÆÂΩï‰∏ã</p>
            <p>Âª∫ËÆÆ‰ΩøÁî®ÊúâÊÑè‰πâÁöÑÂêçÁß∞ÔºåÂ¶ÇÔºöÈü≥‰πê„ÄÅÊïôÁ®ã„ÄÅÊúâÂ£∞‰π¶Á≠â</p>
          </div>
        </div>

        <div class="tip-item">
          <span class="tip-icon">‚å®Ô∏è</span>
          <div class="tip-content">
            <strong>Âø´Êç∑ÈîÆÔºö</strong>
            <ul>
              <li><kbd>Ctrl</kbd> + <kbd>Enter</kbd> - Âø´ÈÄüÊ£ÄÊü•ÂàóË°®</li>
              <li><kbd>Ctrl</kbd> + <kbd>,</kbd> - ÊâìÂºÄËÆæÁΩÆ</li>
              <li><kbd>Ctrl</kbd> + <kbd>D</kbd> - ÂàáÊç¢‰∏ªÈ¢ò</li>
              <li><kbd>Escape</kbd> - ÂÖ≥Èó≠ËÆæÁΩÆ</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ËÆæÁΩÆÂºπÁ™ó -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2 class="settings-title">ËÆæÁΩÆ</h2>
        <button class="close-btn" onclick="hideSettings()">√ó</button>
      </div>

      <!-- Ê†áÁ≠æÈ°µ -->
      <div class="setting-tabs">
        <div class="setting-tab active" onclick="switchTab('download')">‰∏ãËΩΩËÆæÁΩÆ</div>
        <div class="setting-tab" onclick="switchTab('account')">Ë¥¶Âè∑ÁÆ°ÁêÜ</div>
        <div class="setting-tab" onclick="switchTab('history')">‰∏ãËΩΩÂéÜÂè≤</div>
        <div class="setting-tab" onclick="switchTab('about')">ÂÖ≥‰∫é</div>
      </div>

      <!-- ‰∏ãËΩΩËÆæÁΩÆÊ†áÁ≠æÈ°µ -->
      <div class="setting-content active" id="downloadTab">
        <!-- Á≥ªÁªüÁä∂ÊÄÅ -->
        <div class="setting-info" id="systemStatus">
          <span>üîß</span>
          <div>
            <div style="font-weight: 500;">Á≥ªÁªüÁä∂ÊÄÅ</div>
            <div style="font-size: 12px; color: var(--text-secondary);" id="systemStatusText">Ê£ÄÊü•‰∏≠...</div>
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">üìÅ ‰øùÂ≠òË∑ØÂæÑ</label>
          <div class="setting-desc">‰∏ãËΩΩÊñá‰ª∂ÁöÑ‰øùÂ≠òÁõÆÂΩïÔºåÁõ∏ÂØπ‰∫éÁ®ãÂ∫èÊ†πÁõÆÂΩï</div>
          <input type="text" class="input-field" id="settingSavePath" placeholder="audiobooks/test">
          <div class="setting-desc" style="margin-top: 6px; font-size: 11px;">
            üí° Á§∫‰æãÔºöaudiobooks/Èü≥‰πê„ÄÅaudiobooks/ÊïôÁ®ã„ÄÅdownloads/ÊúâÂ£∞‰π¶Á≠â
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">üìù Êñá‰ª∂ÂêçÊ†ºÂºè</label>
          <div class="setting-desc">‰∏ãËΩΩÊñá‰ª∂ÁöÑÂëΩÂêçÊ†ºÂºèÔºåÊîØÊåÅ %(title)s, %(uploader)s Á≠âÂèòÈáè</div>
          <select class="input-field" id="settingTitleRegex">
            <option value="%(title)s.%(ext)s">Ê†áÈ¢ò.Êâ©Â±ïÂêç (Êé®Ëçê)</option>
            <option value="%(uploader)s - %(title)s.%(ext)s">UP‰∏ª - Ê†áÈ¢ò.Êâ©Â±ïÂêç</option>
            <option value="[%(upload_date)s] %(title)s.%(ext)s">[Êó•Êúü] Ê†áÈ¢ò.Êâ©Â±ïÂêç</option>
            <option value="%(playlist_index)s. %(title)s.%(ext)s">Â∫èÂè∑. Ê†áÈ¢ò.Êâ©Â±ïÂêç</option>
            <option value="%(autonumber)s.%(ext)s">Â∫èÂè∑.Êâ©Â±ïÂêç</option>
            <option value="custom">Ëá™ÂÆö‰πâÊ†ºÂºè</option>
          </select>
          <input type="text" class="input-field" id="customTitleRegex" placeholder="Â¶ÇÔºö%(title)s - %(uploader)s.%(ext)s" style="display: none; margin-top: 8px;">
          <div class="setting-desc" style="margin-top: 6px; font-size: 11px;">
            üí° Â∏∏Áî®ÂèòÈáèÔºö%(title)s=Ê†áÈ¢ò„ÄÅ%(uploader)s=UP‰∏ª„ÄÅ%(upload_date)s=‰∏ä‰º†Êó•Êúü„ÄÅ%(ext)s=Êâ©Â±ïÂêç
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">üéµ Èü≥Ë¥®ÈÄâÊã©</label>
          <div class="setting-desc">‰∏ãËΩΩÈü≥È¢ëÁöÑË¥®ÈáèËÆæÁΩÆ</div>
          <select class="input-field" id="settingQuality">
            <option value="bestaudio/best">ÊúÄ‰Ω≥Èü≥Ë¥® (Êé®ËçêÔºåËá™Âä®ÈÄâÊã©ÊúÄ‰Ω≥Ê†ºÂºè)</option>
            <option value="bestaudio[ext=m4a]/best[ext=m4a]">M4AÊ†ºÂºè (È´òË¥®ÈáèÔºåÂÖºÂÆπÊÄßÂ•Ω)</option>
            <option value="bestaudio[ext=mp3]/best[ext=mp3]">MP3Ê†ºÂºè (ÈÄöÁî®ÊÄßÂº∫)</option>
            <option value="bestaudio[ext=opus]/best[ext=opus]">OPUSÊ†ºÂºè (È´òÂéãÁº©ÊØî)</option>
            <option value="worst">ÊúÄ‰ΩéÈü≥Ë¥® (ËäÇÁúÅÁ©∫Èó¥)</option>
          </select>
          <div class="setting-desc" style="margin-top: 6px; font-size: 11px;">
            üí° Êé®Ëçê‰ΩøÁî®"ÊúÄ‰Ω≥Èü≥Ë¥®"ÔºåÁ≥ªÁªü‰ºöËá™Âä®ÈÄâÊã©ÊúÄÈÄÇÂêàÁöÑÈü≥È¢ëÊ†ºÂºèÂíåË¥®Èáè
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">üîÑ ÈáçËØïÊ¨°Êï∞</label>
          <div class="setting-desc">‰∏ãËΩΩÂ§±Ë¥•Êó∂ÁöÑÈáçËØïÊ¨°Êï∞ÔºåÁΩëÁªú‰∏çÁ®≥ÂÆöÊó∂Âª∫ËÆÆËÆæÁΩÆËæÉÈ´òÂÄº</div>
          <input type="range" class="input-field" id="settingRetryCount" min="1" max="10" value="5" oninput="updateRetryDisplay(this.value)">
          <div style="text-align: center; margin-top: 5px; font-size: 14px; color: var(--text-secondary);">
            <span id="retryDisplay">5</span> Ê¨°
          </div>
          <div class="setting-desc" style="margin-top: 6px; font-size: 11px;">
            üí° Êé®ËçêËÆæÁΩÆ 3-5 Ê¨°ÔºåËøáÈ´òÂèØËÉΩÂØºËá¥‰∏ãËΩΩÊó∂Èó¥ËøáÈïø
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-row">
            <div>
              <div class="setting-label">üñºÔ∏è ‰∏ãËΩΩÂ∞ÅÈù¢</div>
              <div class="setting-desc">ÂêåÊó∂‰∏ãËΩΩËßÜÈ¢ëÂ∞ÅÈù¢ÂõæÁâáÔºå‰æø‰∫éËØÜÂà´ÂÜÖÂÆπ</div>
            </div>
            <div class="setting-switch" id="thumbnailSwitch" onclick="toggleSwitch('thumbnailSwitch', 'settingWriteThumbnail')">
            </div>
          </div>
          <input type="hidden" id="settingWriteThumbnail" value="true">
        </div>

        <div class="setting-group">
          <div class="setting-row">
            <div>
              <div class="setting-label">‚úèÔ∏è Ëá™Âä®ÈáçÂëΩÂêç</div>
              <div class="setting-desc">Ëá™Âä®Â§ÑÁêÜÊñá‰ª∂Âêç‰∏≠ÁöÑÁâπÊÆäÂ≠óÁ¨¶ÔºåÁ°Æ‰øùÂÖºÂÆπÊÄß</div>
            </div>
            <div class="setting-switch active" id="autoRenameSwitch" onclick="toggleSwitch('autoRenameSwitch', 'settingAutoRename')">
            </div>
          </div>
          <input type="hidden" id="settingAutoRename" value="true">
        </div>

        <div class="btn-group">
          <button class="btn" onclick="saveSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
          <button class="btn btn-secondary" onclick="resetSettings()">ÈáçÁΩÆÈªòËÆ§</button>
        </div>
      </div>

      <!-- Ë¥¶Âè∑ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
      <div class="setting-content" id="accountTab">
        <!-- ÁôªÂΩïÁä∂ÊÄÅ -->
        <div class="login-status" id="loginStatus">
          <div class="status-dot offline" id="statusDot"></div>
          <div>
            <div style="font-weight: 500;" id="loginStatusText">Êú™ÁôªÂΩï</div>
            <div style="font-size: 12px; color: var(--text-secondary);" id="loginStatusDesc">ÁôªÂΩïÂêéÂèØ‰∏ãËΩΩ‰ºöÂëò‰∏ì‰∫´ÂÜÖÂÆπ</div>
          </div>
        </div>

        <!-- ‰∫åÁª¥Á†ÅÁôªÂΩï -->
        <div class="qr-container" id="qrContainer" style="display: none;">
          <div class="qr-code" id="qrCode">
            <div>ËØ∑‰ΩøÁî®ÂìîÂì©ÂìîÂì©APPÊâ´Á†ÅÁôªÂΩï</div>
          </div>
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">
            Êâ´Á†ÅÂêéËØ∑Âú®APP‰∏≠Á°ÆËÆ§ÁôªÂΩï
          </div>
          <div style="font-size: 12px; color: var(--text-secondary);">
            ‰∫åÁª¥Á†ÅÊúâÊïàÊúü: <span id="qrExpiry">180</span>Áßí
          </div>
        </div>

        <div class="btn-group">
          <button class="btn" onclick="generateQRCode()" id="loginBtn">ÁîüÊàêÁôªÂΩï‰∫åÁª¥Á†Å</button>
          <button class="btn btn-secondary" onclick="forceGenerateQRCode()" id="forceLoginBtn">Âº∫Âà∂ÈáçÊñ∞ÁôªÂΩï</button>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="clearCookies()">Ê∏ÖÈô§ÁôªÂΩï‰ø°ÊÅØ</button>
          <button class="btn btn-secondary" onclick="exportCookies()">ÂØºÂá∫Cookies</button>
        </div>

        <!-- Ë¥¶Âè∑‰ø°ÊÅØ -->
        <div class="setting-group" id="accountInfo" style="display: none;">
          <label class="setting-label">Ë¥¶Âè∑‰ø°ÊÅØ</label>
          <div class="setting-info" id="userInfo">
            <span>üë§</span>
            <div>
              <div style="font-weight: 500;" id="userName">Âä†ËΩΩ‰∏≠...</div>
              <div style="font-size: 12px; color: var(--text-secondary);" id="userLevel">Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ‰∏≠...</div>
            </div>
          </div>
          <div class="setting-info" id="memberInfo" style="display: none;">
            <span>üíé</span>
            <div>
              <div style="font-weight: 500;" id="memberType">‰ºöÂëòÁ±ªÂûã</div>
              <div style="font-size: 12px; color: var(--text-secondary);" id="memberExpiry">Âà∞ÊúüÊó∂Èó¥</div>
            </div>
          </div>
          <div class="setting-info" id="statsInfo" style="display: none;">
            <span>üìä</span>
            <div>
              <div style="font-weight: 500;">Ë¥¶Âè∑ÁªüËÆ°</div>
              <div style="font-size: 12px; color: var(--text-secondary);" id="userStats">ÂÖ≥Ê≥®/Á≤â‰∏ù/Ëé∑Ëµû</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‰∏ãËΩΩÂéÜÂè≤Ê†áÁ≠æÈ°µ -->
      <div class="setting-content" id="historyTab">
        <!-- ÁªüËÆ°‰ø°ÊÅØ -->
        <div class="setting-info">
          <span>üìä</span>
          <div>
            <div style="font-weight: 500;">‰∏ãËΩΩÁªüËÆ°</div>
            <div style="font-size: 12px; color: var(--text-secondary);" id="downloadStats">ÊÄªËÆ°‰∏ãËΩΩ: 0 ‰∏™Êñá‰ª∂</div>
          </div>
        </div>

        <!-- Á≠õÈÄâÈÄâÈ°π -->
        <div class="setting-group">
          <label class="setting-label">Á≠õÈÄâÊù°‰ª∂</label>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="filterHistory('all')" id="filterAll">ÂÖ®ÈÉ®</button>
            <button class="btn btn-secondary" onclick="filterHistory('completed')" id="filterCompleted">Â∑≤ÂÆåÊàê</button>
            <button class="btn btn-secondary" onclick="filterHistory('failed')" id="filterFailed">Â§±Ë¥•</button>
          </div>
        </div>

        <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂàóË°® -->
        <div class="setting-group">
          <label class="setting-label">‰∏ãËΩΩÂéÜÂè≤</label>
          <div id="historyList" style="max-height: 300px; overflow-y: auto;">
            <div class="setting-info" style="text-align: center; color: var(--text-secondary);">
              <span>üìù</span>
              <div>ÊöÇÊó†‰∏ãËΩΩËÆ∞ÂΩï</div>
            </div>
          </div>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="refreshHistory()">Âà∑Êñ∞ÂéÜÂè≤</button>
          <button class="btn btn-secondary" onclick="clearHistory()">Ê∏ÖÁ©∫ÂéÜÂè≤</button>
        </div>

        <!-- Áîü‰∫ßÊ®°Âºè‰∏ãÈöêËóèÂØºÂá∫ÂíåÊâìÂºÄÁõÆÂΩïÂäüËÉΩ -->
        <div class="btn-group" style="display: none;">
          <button class="btn btn-secondary" onclick="exportHistory()">ÂØºÂá∫ÂéÜÂè≤</button>
          <button class="btn btn-secondary" onclick="openDownloadFolder()">ÊâìÂºÄ‰∏ãËΩΩÁõÆÂΩï</button>
        </div>
      </div>

      <!-- ÂÖ≥‰∫éÊ†áÁ≠æÈ°µ -->
      <div class="setting-content" id="aboutTab">
        <div class="setting-info">
          <span>üéµ</span>
          <div>
            <div style="font-weight: 500;">LazyBala</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Ë¥πÂä≤Â∑¥Êãâ‰∏ãËΩΩÂô® v1.0.0</div>
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">ÂäüËÉΩÁâπËâ≤</label>
          <div class="setting-desc">
            ‚Ä¢ ÊîØÊåÅÂìîÂì©ÂìîÂì©Èü≥È¢ë‰∏ãËΩΩ<br>
            ‚Ä¢ ÊâπÈáè‰∏ãËΩΩÊí≠ÊîæÂàóË°®<br>
            ‚Ä¢ Ëá™Âä®Ëé∑ÂèñÊúÄ‰Ω≥Èü≥Ë¥®<br>
            ‚Ä¢ ÊîØÊåÅ‰ºöÂëò‰∏ì‰∫´ÂÜÖÂÆπ<br>
            ‚Ä¢ ÂÆûÊó∂‰∏ãËΩΩËøõÂ∫¶ÊòæÁ§∫
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">ÊäÄÊúØÊ†à</label>
          <div class="setting-desc">
            ‚Ä¢ ÂêéÁ´Ø: Go + Gin + WebSocket<br>
            ‚Ä¢ ÂâçÁ´Ø: Á∫ØHTML + CSS + JavaScript<br>
            ‚Ä¢ ‰∏ãËΩΩ: yt-dlp + ffmpeg<br>
            ‚Ä¢ ÂÆπÂô®: DockerÊîØÊåÅ
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">Âø´Êç∑ÈîÆ</label>
          <div class="setting-desc">
            ‚Ä¢ <kbd>Ctrl/Cmd + Enter</kbd> Âø´ÈÄüÊ£ÄÊü•ÂàóË°®<br>
            ‚Ä¢ <kbd>Ctrl/Cmd + ,</kbd> ÊâìÂºÄËÆæÁΩÆ<br>
            ‚Ä¢ <kbd>Ctrl/Cmd + D</kbd> ÂàáÊç¢‰∏ªÈ¢ò<br>
            ‚Ä¢ <kbd>Ctrl/Cmd + H</kbd> Êü•ÁúãÂéÜÂè≤<br>
            ‚Ä¢ <kbd>Escape</kbd> ÂÖ≥Èó≠ËÆæÁΩÆ
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">ÁâàÊú¨‰ø°ÊÅØ</label>
          <div class="setting-info" id="versionInfo">
            <span>üì¶</span>
            <div>
              <div style="font-weight: 500;">Ê£ÄÊü•Êõ¥Êñ∞</div>
              <div style="font-size: 12px; color: var(--text-secondary);" id="versionText">ÂΩìÂâçÁâàÊú¨: v1.0.0</div>
            </div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="checkUpdate()">Ê£ÄÊü•Êõ¥Êñ∞</button>
          <button class="btn btn-secondary" onclick="updateYtDlp()" id="updateYtDlpBtn">Êõ¥Êñ∞ yt-dlp</button>
          <button class="btn btn-secondary" onclick="viewLogs()">Êü•ÁúãÊó•Âøó</button>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="openGithub()">GitHubÈ°πÁõÆ</button>
          <button class="btn btn-secondary" onclick="reportIssue()">ÂèçÈ¶àÈóÆÈ¢ò</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    console.log('ÊµãËØïÈ°µÈù¢Â∑≤Âä†ËΩΩ');

    // ÂÖ®Â±ÄÂèòÈáè
    let downloadHistory = [];
    let currentFilter = 'all';

    // ‰∏ªÈ¢òÁÆ°ÁêÜ
    let currentTheme = localStorage.getItem('theme') || 'dark';

    // ÂàùÂßãÂåñ‰∏ªÈ¢ò
    function initTheme() {
      if (currentTheme === 'light') {
        document.body.setAttribute('data-theme', 'light');
        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
      } else {
        document.body.removeAttribute('data-theme');
        document.getElementById('themeToggle').textContent = 'üåô';
      }
    }

    // ÂàáÊç¢‰∏ªÈ¢ò
    function toggleTheme() {
      currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', currentTheme);
      initTheme();
    }

    // ÊòæÁ§∫ËÆæÁΩÆ
    function showSettings() {
      loadSettings();
      document.getElementById('settingsModal').classList.add('show');
    }

    // ÈöêËóèËÆæÁΩÆ
    function hideSettings() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    // Âä†ËΩΩËÆæÁΩÆ
    async function loadSettings() {
      try {
        const response = await fetch('/api/config');
        if (response.ok) {
          const config = await response.json();

          // Âü∫Êú¨ËÆæÁΩÆ
          document.getElementById('settingSavePath').value = config.save_path || '';

          // Êñá‰ª∂ÂêçÊ†ºÂºè
          const titleRegex = config.title_regex || '%(title)s.%(ext)s';
          const titleSelect = document.getElementById('settingTitleRegex');
          const customInput = document.getElementById('customTitleRegex');

          // Ê£ÄÊü•ÊòØÂê¶ÊòØÈ¢ÑËÆæÊ†ºÂºè
          let isCustom = true;
          for (let option of titleSelect.options) {
            if (option.value === titleRegex && option.value !== 'custom') {
              titleSelect.value = titleRegex;
              isCustom = false;
              break;
            }
          }

          if (isCustom) {
            titleSelect.value = 'custom';
            customInput.value = titleRegex;
            customInput.style.display = 'block';
          }

          // Èü≥Ë¥®ËÆæÁΩÆ
          document.getElementById('settingQuality').value = config.quality || 'bestaudio/best';

          // ÈáçËØïÊ¨°Êï∞
          const retryCount = config.retry_count || 5;
          document.getElementById('settingRetryCount').value = retryCount;
          document.getElementById('retryDisplay').textContent = retryCount;

          // ÂºÄÂÖ≥ËÆæÁΩÆ
          const writeThumbnail = config.write_thumbnail !== false;
          document.getElementById('settingWriteThumbnail').value = writeThumbnail ? 'true' : 'false';
          const thumbnailSwitch = document.getElementById('thumbnailSwitch');
          if (writeThumbnail) {
            thumbnailSwitch.classList.add('active');
          } else {
            thumbnailSwitch.classList.remove('active');
          }

          // Ëá™Âä®ÈáçÂëΩÂêçÈªòËÆ§ÂºÄÂêØ
          document.getElementById('settingAutoRename').value = 'true';
          document.getElementById('autoRenameSwitch').classList.add('active');
        }
      } catch (error) {
        console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', error);
      }
    }

    // ‰øùÂ≠òËÆæÁΩÆ
    async function saveSettings() {
      // Ëé∑ÂèñÊñá‰ª∂ÂêçÊ†ºÂºè
      const titleSelect = document.getElementById('settingTitleRegex');
      let titleRegex = titleSelect.value;
      if (titleRegex === 'custom') {
        titleRegex = document.getElementById('customTitleRegex').value;
      }

      const settings = {
        save_path: document.getElementById('settingSavePath').value,
        title_regex: titleRegex,
        quality: document.getElementById('settingQuality').value,
        retry_count: parseInt(document.getElementById('settingRetryCount').value),
        write_thumbnail: document.getElementById('settingWriteThumbnail').value === 'true',
        auto_rename: document.getElementById('settingAutoRename').value === 'true'
      };

      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
          const statusEl = document.getElementById('systemStatus');
          const statusTextEl = document.getElementById('systemStatusText');
          statusEl.className = 'setting-info success';
          statusTextEl.textContent = 'ËÆæÁΩÆÂ∑≤‰øùÂ≠ò';

          setTimeout(() => {
            checkSystemStatus();
          }, 2000);
        } else {
          alert('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•');
        }
      } catch (error) {
        console.error('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•:', error);
        alert('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•');
      }
    }

    // ÈáçÁΩÆËÆæÁΩÆ
    function resetSettings() {
      document.getElementById('settingSavePath').value = '';
      document.getElementById('settingTitleRegex').value = '%(title)s.%(ext)s';
      document.getElementById('customTitleRegex').style.display = 'none';
      document.getElementById('settingQuality').value = 'bestaudio/best';
      document.getElementById('settingRetryCount').value = 5;
      document.getElementById('retryDisplay').textContent = '5';

      // ÈáçÁΩÆÂºÄÂÖ≥
      document.getElementById('thumbnailSwitch').classList.add('active');
      document.getElementById('settingWriteThumbnail').value = 'true';
      document.getElementById('autoRenameSwitch').classList.add('active');
      document.getElementById('settingAutoRename').value = 'true';
    }

    // Êñá‰ª∂ÂêçÊ†ºÂºèÈÄâÊã©‰∫ã‰ª∂
    document.addEventListener('DOMContentLoaded', function() {
      const titleSelect = document.getElementById('settingTitleRegex');
      const customInput = document.getElementById('customTitleRegex');

      titleSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          customInput.style.display = 'block';
          customInput.focus();
        } else {
          customInput.style.display = 'none';
        }
      });
    });

    // ÊòæÁ§∫ÁôªÂΩïÂØπËØùÊ°Ü
    function showLoginDialog() {
      alert('ÁôªÂΩïÂäüËÉΩÂºÄÂèë‰∏≠...\nÂ∞ÜÊîØÊåÅ‰∫åÁª¥Á†ÅÁôªÂΩïËé∑Âèñcookies');
    }

    // Ê∏ÖÈô§cookies
    async function clearCookies() {
      if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÁôªÂΩï‰ø°ÊÅØÂêóÔºü\nÊ∏ÖÈô§ÂêéÂ∞ÜÊó†Ê≥ï‰∏ãËΩΩ‰ºöÂëò‰∏ì‰∫´ÂÜÖÂÆπ„ÄÇ')) {
        try {
          // ÂèëÈÄÅÊ∏ÖÈô§cookiesËØ∑Ê±Ç
          const response = await fetch('/api/auth/logout', { method: 'POST' });

          if (response.ok) {
            // Êõ¥Êñ∞UIÁä∂ÊÄÅ
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('loginStatusText');
            const statusDesc = document.getElementById('loginStatusDesc');

            statusDot.className = 'status-dot offline';
            statusText.textContent = 'Êú™ÁôªÂΩï';
            statusDesc.textContent = 'ÁôªÂΩïÂêéÂèØ‰∏ãËΩΩ‰ºöÂëò‰∏ì‰∫´ÂÜÖÂÆπ';
            document.getElementById('accountInfo').style.display = 'none';

            // ÈöêËóè‰∫åÁª¥Á†Å
            document.getElementById('qrContainer').style.display = 'none';

            // Êõ¥Êñ∞Á≥ªÁªüÁä∂ÊÄÅ
            checkSystemStatus();

            alert('ÁôªÂΩï‰ø°ÊÅØÂ∑≤Ê∏ÖÈô§');
          } else {
            // Âç≥‰ΩøÂêéÁ´ØÊ≤°ÊúâÂØπÂ∫îAPIÔºå‰πüÊ®°ÊãüÊ∏ÖÈô§ÊàêÂäü
            alert('ÁôªÂΩï‰ø°ÊÅØÂ∑≤Ê∏ÖÈô§');
            updateLoginStatus();
          }
        } catch (error) {
          console.error('Ê∏ÖÈô§ÁôªÂΩï‰ø°ÊÅØÂ§±Ë¥•:', error);
          alert('Ê∏ÖÈô§ÁôªÂΩï‰ø°ÊÅØÂ§±Ë¥•: ' + error.message);
        }
      }
    }

    // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠
    document.getElementById('settingsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideSettings();
      }
    });

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ (Â∑≤ÁßªËá≥WebSocketÂàùÂßãÂåñÂ§Ñ)

    // ËÆæÁΩÆÈîÆÁõòÂø´Êç∑ÈîÆ
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Enter: Âø´ÈÄüÊ£ÄÊü•ÂàóË°®
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          handleCheckList();
        }

        // Ctrl/Cmd + ,: ÊâìÂºÄËÆæÁΩÆ
        if ((e.ctrlKey || e.metaKey) && e.key === ',') {
          e.preventDefault();
          showSettings();
        }

        // Escape: ÂÖ≥Èó≠ËÆæÁΩÆ
        if (e.key === 'Escape') {
          hideSettings();
        }

        // Ctrl/Cmd + D: ÂàáÊç¢‰∏ªÈ¢ò
        if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
          e.preventDefault();
          toggleTheme();
        }

        // Ctrl/Cmd + H: Êü•ÁúãÂéÜÂè≤
        if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
          e.preventDefault();
          showSettings();
          setTimeout(() => switchTab('history'), 100);
        }
      });
    }

    // Ê†áÁ≠æÈ°µÂàáÊç¢
    function switchTab(tabName) {
      // ÁßªÈô§ÊâÄÊúâÊ¥ªÂä®Áä∂ÊÄÅ
      document.querySelectorAll('.setting-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.setting-content').forEach(content => content.classList.remove('active'));

      // ÊøÄÊ¥ªÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');

      // Ê†πÊçÆÊ†áÁ≠æÈ°µÊâßË°åÁõ∏Â∫îÊìç‰Ωú
      if (tabName === 'account') {
        updateLoginStatus();
      } else if (tabName === 'history') {
        refreshHistory();
      }
    }

    // ÂºÄÂÖ≥ÂàáÊç¢
    function toggleSwitch(switchId, inputId) {
      const switchEl = document.getElementById(switchId);
      const inputEl = document.getElementById(inputId);

      switchEl.classList.toggle('active');
      inputEl.value = switchEl.classList.contains('active') ? 'true' : 'false';
    }

    // Êõ¥Êñ∞ÈáçËØïÊ¨°Êï∞ÊòæÁ§∫
    function updateRetryDisplay(value) {
      document.getElementById('retryDisplay').textContent = value;
    }

    // Ê£ÄÊü•Á≥ªÁªüÁä∂ÊÄÅ
    async function checkSystemStatus() {
      try {
        const response = await fetch('/api/config');
        if (response.ok) {
          const config = await response.json();
          const statusEl = document.getElementById('systemStatus');
          const statusTextEl = document.getElementById('systemStatusText');

          if (config.has_cookies && config.cookies_valid) {
            statusEl.className = 'setting-info success';
            statusTextEl.textContent = 'Á≥ªÁªüÊ≠£Â∏∏ÔºåÂ∑≤ÁôªÂΩï';
          } else {
            statusEl.className = 'setting-info warning';
            statusTextEl.textContent = 'Á≥ªÁªüÊ≠£Â∏∏ÔºåÊú™ÁôªÂΩï';
          }
        }
      } catch (error) {
        const statusEl = document.getElementById('systemStatus');
        const statusTextEl = document.getElementById('systemStatusText');
        statusEl.className = 'setting-info error';
        statusTextEl.textContent = 'Á≥ªÁªüËøûÊé•Â§±Ë¥•';
      }
    }

    // Êõ¥Êñ∞ÁôªÂΩïÁä∂ÊÄÅ
    async function updateLoginStatus() {
      try {
        const response = await fetch('/api/config');
        if (response.ok) {
          const config = await response.json();
          const statusDot = document.getElementById('statusDot');
          const statusText = document.getElementById('loginStatusText');
          const statusDesc = document.getElementById('loginStatusDesc');

          if (config.has_cookies && config.cookies_valid) {
            statusDot.className = 'status-dot online';
            statusText.textContent = 'Â∑≤ÁôªÂΩï';
            statusDesc.textContent = 'ÂèØ‰ª•‰∏ãËΩΩ‰ºöÂëò‰∏ì‰∫´ÂÜÖÂÆπ';
            document.getElementById('accountInfo').style.display = 'block';
            // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
            getUserInfo();
          } else {
            statusDot.className = 'status-dot offline';
            statusText.textContent = 'Êú™ÁôªÂΩï';
            statusDesc.textContent = 'ÁôªÂΩïÂêéÂèØ‰∏ãËΩΩ‰ºöÂëò‰∏ì‰∫´ÂÜÖÂÆπ';
            document.getElementById('accountInfo').style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', error);
      }
    }

    // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
    async function getUserInfo() {
      try {
        const response = await fetch('/api/user/info');
        if (response.ok) {
          const userInfo = await response.json();
          updateUserInfoDisplay(userInfo);
        } else {
          // Â¶ÇÊûúAPI‰∏çÂ≠òÂú®ÔºåÊòæÁ§∫ÈªòËÆ§‰ø°ÊÅØ
          updateUserInfoDisplay({
            name: 'Â∑≤ÁôªÂΩïÁî®Êà∑',
            level: 'Á≠âÁ∫ß‰ø°ÊÅØËé∑Âèñ‰∏≠...',
            vip_type: 0,
            vip_status: 0
          });
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
        // ÊòæÁ§∫ÈªòËÆ§‰ø°ÊÅØ
        updateUserInfoDisplay({
          name: 'Â∑≤ÁôªÂΩïÁî®Êà∑',
          level: 'Á≠âÁ∫ß‰ø°ÊÅØËé∑Âèñ‰∏≠...',
          vip_type: 0,
          vip_status: 0
        });
      }
    }

    // Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÊòæÁ§∫
    function updateUserInfoDisplay(userInfo) {
      // Âü∫Êú¨Áî®Êà∑‰ø°ÊÅØ
      const userNameEl = document.getElementById('userName');
      const userLevelEl = document.getElementById('userLevel');

      if (userNameEl) {
        userNameEl.textContent = userInfo.name || 'Áî®Êà∑';
      }

      if (userLevelEl) {
        userLevelEl.textContent = `Á≠âÁ∫ß ${userInfo.level || 'N/A'}`;
      }

      // ‰ºöÂëò‰ø°ÊÅØ
      const memberInfoEl = document.getElementById('memberInfo');
      const memberTypeEl = document.getElementById('memberType');
      const memberExpiryEl = document.getElementById('memberExpiry');

      if (userInfo.vip_status === 1) {
        memberInfoEl.style.display = 'block';
        const vipTypes = {
          0: 'Êó†‰ºöÂëò',
          1: 'ÊúàÂ∫¶Â§ß‰ºöÂëò',
          2: 'Âπ¥Â∫¶Â§ß‰ºöÂëò'
        };
        memberTypeEl.textContent = vipTypes[userInfo.vip_type] || 'Â§ß‰ºöÂëò';
        memberExpiryEl.textContent = userInfo.vip_due_date ?
          `Âà∞ÊúüÊó∂Èó¥: ${new Date(userInfo.vip_due_date * 1000).toLocaleDateString()}` :
          '‰ºöÂëòÊúâÊïà';
      } else {
        memberInfoEl.style.display = 'none';
      }

      // ÁªüËÆ°‰ø°ÊÅØ
      const statsInfoEl = document.getElementById('statsInfo');
      const userStatsEl = document.getElementById('userStats');

      if (userInfo.following !== undefined || userInfo.follower !== undefined) {
        statsInfoEl.style.display = 'block';
        userStatsEl.textContent = `ÂÖ≥Ê≥®: ${userInfo.following || 0} | Á≤â‰∏ù: ${userInfo.follower || 0}`;
      } else {
        statsInfoEl.style.display = 'none';
      }
    }

    // ÁîüÊàê‰∫åÁª¥Á†Å
    async function generateQRCode() {
      try {
        const response = await fetch('/api/qrcode/generate', { method: 'POST' });
        if (response.ok) {
          const data = await response.json();
          console.log('‰∫åÁª¥Á†ÅAPIÂìçÂ∫î:', data);

          if (data.already_logged_in) {
            // Â∑≤ÁªèÁôªÂΩïÔºåÊòæÁ§∫ÊèêÁ§∫
            alert(data.message || 'Â∑≤ÊàêÂäüÁôªÂΩïÔºå‰∏çÈúÄË¶ÅÊâ´Á†Å');
            updateLoginStatus(); // Êõ¥Êñ∞ÁôªÂΩïÁä∂ÊÄÅÊòæÁ§∫
            return;
          }

          if (data.qrcode && data.qrcode_key) {
            const qrContainer = document.getElementById('qrContainer');
            const qrCode = document.getElementById('qrCode');

            qrCode.innerHTML = `<img src="data:image/png;base64,${data.qrcode}" style="width: 100%; height: 100%; object-fit: contain;">`;
            qrContainer.style.display = 'block';

            // ÂºÄÂßãÂÄíËÆ°Êó∂
            startQRCountdown(180);

            // ÂºÄÂßãÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
            checkQRLogin(data.qrcode_key);
          } else {
            alert('‰∫åÁª¥Á†ÅÊï∞ÊçÆÊ†ºÂºèÈîôËØØ');
          }
        } else {
          const errorData = await response.json();
          alert('ÁîüÊàê‰∫åÁª¥Á†ÅÂ§±Ë¥•: ' + (errorData.error || 'Êú™Áü•ÈîôËØØ'));
        }
      } catch (error) {
        console.error('ÁîüÊàê‰∫åÁª¥Á†ÅÂ§±Ë¥•:', error);
        alert('ÁîüÊàê‰∫åÁª¥Á†ÅÂ§±Ë¥•: ' + error.message);
      }
    }

    // ‰∫åÁª¥Á†ÅÂÄíËÆ°Êó∂
    let qrTimer = null;
    let qrCheckInterval = null;

    function startQRCountdown(seconds) {
      const expiryEl = document.getElementById('qrExpiry');
      let remaining = seconds;

      // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
      if (qrTimer) {
        clearInterval(qrTimer);
      }

      qrTimer = setInterval(() => {
        remaining--;
        expiryEl.textContent = remaining;

        if (remaining <= 0) {
          clearInterval(qrTimer);
          // Ê∏ÖÈô§ÁôªÂΩïÊ£ÄÊü•ÂÆöÊó∂Âô®
          if (qrCheckInterval) {
            clearInterval(qrCheckInterval);
          }
          // Ëá™Âä®ÈáçÊñ∞ÁîüÊàê‰∫åÁª¥Á†ÅÔºå‰∏çÊòæÁ§∫ÊèêÁ§∫
          generateQRCode();
        }
      }, 1000);
    }

    // Ê£ÄÊü•‰∫åÁª¥Á†ÅÁôªÂΩïÁä∂ÊÄÅ
    async function checkQRLogin(qrcodeKey) {
      // Ê∏ÖÈô§‰πãÂâçÁöÑÊ£ÄÊü•ÂÆöÊó∂Âô®
      if (qrCheckInterval) {
        clearInterval(qrCheckInterval);
      }

      qrCheckInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/qrcode/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qrcode_key: qrcodeKey })
          });

          if (response.ok) {
            const data = await response.json();
            if (data.code === 0) {
              clearInterval(qrCheckInterval);
              clearInterval(qrTimer); // Ê∏ÖÈô§ÂÄíËÆ°Êó∂
              document.getElementById('qrContainer').style.display = 'none';
              alert('ÁôªÂΩïÊàêÂäüÔºÅ');
              updateLoginStatus();
              getUserInfo(); // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
            }
          }
        } catch (error) {
          console.error('Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', error);
        }
      }, 2000);

      // 3ÂàÜÈíüÂêéÂÅúÊ≠¢Ê£ÄÊü•ÔºàÁî±ÂÄíËÆ°Êó∂Ëá™Âä®Â§ÑÁêÜÔºâ
      setTimeout(() => {
        if (qrCheckInterval) {
          clearInterval(qrCheckInterval);
        }
      }, 180000);
    }

    // Âº∫Âà∂ÁîüÊàê‰∫åÁª¥Á†Å
    async function forceGenerateQRCode() {
      try {
        const response = await fetch('/api/qrcode/force-generate', { method: 'POST' });
        if (response.ok) {
          const data = await response.json();
          console.log('Âº∫Âà∂ÁîüÊàê‰∫åÁª¥Á†ÅAPIÂìçÂ∫î:', data);

          if (data.qrcode && data.qrcode_key) {
            const qrContainer = document.getElementById('qrContainer');
            const qrCode = document.getElementById('qrCode');

            qrCode.innerHTML = `<img src="data:image/png;base64,${data.qrcode}" style="width: 100%; height: 100%; object-fit: contain;">`;
            qrContainer.style.display = 'block';

            // ÂºÄÂßãÂÄíËÆ°Êó∂
            startQRCountdown(180);

            // ÂºÄÂßãÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
            checkQRLogin(data.qrcode_key);
          } else {
            alert('‰∫åÁª¥Á†ÅÊï∞ÊçÆÊ†ºÂºèÈîôËØØ');
          }
        } else {
          const errorData = await response.json();
          alert('ÁîüÊàê‰∫åÁª¥Á†ÅÂ§±Ë¥•: ' + (errorData.error || 'Êú™Áü•ÈîôËØØ'));
        }
      } catch (error) {
        console.error('Âº∫Âà∂ÁîüÊàê‰∫åÁª¥Á†ÅÂ§±Ë¥•:', error);
        alert('Âº∫Âà∂ÁîüÊàê‰∫åÁª¥Á†ÅÂ§±Ë¥•: ' + error.message);
      }
    }

    // ÂØºÂá∫Cookies
    async function exportCookies() {
      try {
        const response = await fetch('/api/auth/export-cookies');
        if (response.ok) {
          const data = await response.json();

          if (data.cookies) {
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const cookiesText = data.cookies;
            const blob = new Blob([cookiesText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bilibili_cookies_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            alert('CookiesÂØºÂá∫ÊàêÂäüÔºÅ');
          } else {
            alert('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑCookies');
          }
        } else {
          // Â¶ÇÊûúAPI‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïËØªÂèñÊú¨Âú∞cookiesÊñá‰ª∂
          const fallbackResponse = await fetch('/cookies/cookies.txt');
          if (fallbackResponse.ok) {
            const cookiesText = await fallbackResponse.text();
            const blob = new Blob([cookiesText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bilibili_cookies_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            alert('CookiesÂØºÂá∫ÊàêÂäüÔºÅ');
          } else {
            alert('Ê≤°ÊúâÊâæÂà∞CookiesÊñá‰ª∂');
          }
        }
      } catch (error) {
        console.error('ÂØºÂá∫CookiesÂ§±Ë¥•:', error);
        alert('ÂØºÂá∫CookiesÂ§±Ë¥•: ' + error.message);
      }
    }

    // Ê£ÄÊü•Êõ¥Êñ∞
    async function checkUpdate() {
      try {
        const response = await fetch('/api/version/check');
        if (response.ok) {
          const data = await response.json();

          let message = '=== ÁâàÊú¨Ê£ÄÊü•ÁªìÊûú ===\n\n';

          // LazyBalaÂ∫îÁî®ÁâàÊú¨‰ø°ÊÅØ
          message += 'üì± LazyBala Â∫îÁî®:\n';
          message += `   ÂΩìÂâçÁâàÊú¨: ${data.app.current}\n`;
          if (data.app.error) {
            message += `   Ê£ÄÊü•Â§±Ë¥•: ${data.app.error}\n`;
          } else {
            message += `   ÊúÄÊñ∞ÁâàÊú¨: ${data.app.latest}\n`;
            message += `   Áä∂ÊÄÅ: ${data.app.has_update ? 'üîÑ ÂèëÁé∞Êñ∞ÁâàÊú¨ÔºÅ' : '‚úÖ Â∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨'}\n`;
          }

          message += '\n';

          // yt-dlpÁâàÊú¨‰ø°ÊÅØ
          message += 'üîß yt-dlp Â∑•ÂÖ∑:\n';
          message += `   ÂΩìÂâçÁâàÊú¨: ${data.ytdlp.current}\n`;
          if (data.ytdlp.error) {
            message += `   Ê£ÄÊü•Â§±Ë¥•: ${data.ytdlp.error}\n`;
          } else {
            message += `   ÊúÄÊñ∞ÁâàÊú¨: ${data.ytdlp.latest}\n`;
            message += `   Áä∂ÊÄÅ: ${data.ytdlp.has_update ? 'üîÑ ÂèëÁé∞Êñ∞ÁâàÊú¨ÔºÅ' : '‚úÖ Â∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨'}\n`;
          }

          // Êõ¥Êñ∞ÊèêÁ§∫
          if (data.app.has_update || data.ytdlp.has_update) {
            message += '\nüí° Êõ¥Êñ∞ÊèêÁ§∫:\n';
            if (data.app.has_update) {
              message += '‚Ä¢ LazyBala Â∫îÁî®ÊúâÊñ∞ÁâàÊú¨ÔºåËØ∑ËÆøÈóÆ GitHub ‰∏ãËΩΩ\n';
            }
            if (data.ytdlp.has_update) {
              message += '‚Ä¢ yt-dlp Â∑•ÂÖ∑ÊúâÊñ∞ÁâàÊú¨ÔºåÂèØÂú®ËÆæÁΩÆ‰∏≠‰∏ÄÈîÆÊõ¥Êñ∞\n';
            }
          }

          alert(message);

          // Êõ¥Êñ∞ÁâàÊú¨ÊòæÁ§∫
          const versionText = document.getElementById('versionText');
          if (versionText) {
            versionText.textContent = `LazyBala: ${data.app.current} | yt-dlp: ${data.ytdlp.current}`;
          }
        }
      } catch (error) {
        console.error('Ê£ÄÊü•Êõ¥Êñ∞Â§±Ë¥•:', error);
        alert('Ê£ÄÊü•Êõ¥Êñ∞Â§±Ë¥•: ' + error.message);
      }
    }

    // Êõ¥Êñ∞ yt-dlp
    async function updateYtDlp() {
      const updateBtn = document.getElementById('updateYtDlpBtn');
      const originalText = updateBtn.textContent;

      if (!confirm('Á°ÆÂÆöË¶ÅÊõ¥Êñ∞ yt-dlp Âà∞ÊúÄÊñ∞ÁâàÊú¨ÂêóÔºü\n\nÊõ¥Êñ∞ËøáÁ®ã‰∏≠‰∏ãËΩΩÂäüËÉΩÂ∞ÜÊöÇÊó∂‰∏çÂèØÁî®„ÄÇ')) {
        return;
      }

      try {
        updateBtn.disabled = true;
        updateBtn.textContent = 'Êõ¥Êñ∞‰∏≠...';

        const response = await fetch('/api/version/update', {
          method: 'POST'
        });

        if (response.ok) {
          const data = await response.json();
          alert('‚úÖ ' + data.message + '\n\nÊõ¥Êñ∞ÂÆåÊàêÂêé‰ºöËá™Âä®ÁîüÊïàÔºåÊó†ÈúÄÈáçÂêØÂ∫îÁî®„ÄÇ');

          // 5ÁßíÂêéÈáçÊñ∞Ê£ÄÊü•ÁâàÊú¨
          setTimeout(async () => {
            try {
              const checkResponse = await fetch('/api/version/check');
              if (checkResponse.ok) {
                const versionData = await checkResponse.json();
                const versionText = document.getElementById('versionText');
                if (versionText) {
                  versionText.textContent = `LazyBala: ${versionData.app.current} | yt-dlp: ${versionData.ytdlp.current}`;
                }
              }
            } catch (error) {
              console.error('ÈáçÊñ∞Ê£ÄÊü•ÁâàÊú¨Â§±Ë¥•:', error);
            }
          }, 5000);

        } else {
          const error = await response.json();
          alert('‚ùå Êõ¥Êñ∞Â§±Ë¥•: ' + (error.error || 'Êú™Áü•ÈîôËØØ'));
        }
      } catch (error) {
        console.error('Êõ¥Êñ∞Â§±Ë¥•:', error);
        alert('‚ùå Êõ¥Êñ∞Â§±Ë¥•: ' + error.message);
      } finally {
        updateBtn.disabled = false;
        updateBtn.textContent = originalText;
      }
    }

    // Êü•ÁúãÊó•Âøó
    function viewLogs() {
      window.open('/logs', '_blank');
    }

    // ÊâìÂºÄGitHub
    function openGithub() {
      window.open('https://github.com/kis2show/lazybala', '_blank');
    }

    // ÂèçÈ¶àÈóÆÈ¢ò
    function reportIssue() {
      window.open('https://github.com/kis2show/lazybala/issues', '_blank');
    }

    // ÂéÜÂè≤ËÆ∞ÂΩïÁõ∏ÂÖ≥ÂäüËÉΩ
    // Âà∑Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï
    async function refreshHistory() {
      try {
        const response = await fetch('/api/download/history');
        if (response.ok) {
          const data = await response.json();
          downloadHistory = data.tasks || [];
          console.log('Ëé∑ÂèñÂà∞ÂéÜÂè≤ËÆ∞ÂΩï:', downloadHistory);
          console.log('Â∑≤ÂÆåÊàêËÆ∞ÂΩïÊï∞Èáè:', downloadHistory.filter(item => item.status === 'completed').length);
          updateHistoryDisplay();
          updateDownloadStats();
        } else {
          // Â¶ÇÊûúAPI‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
          loadMockHistory();
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
        loadMockHistory();
      }
    }

    // Âä†ËΩΩÊ®°ÊãüÂéÜÂè≤Êï∞ÊçÆ
    function loadMockHistory() {
      downloadHistory = [
        {
          id: 1,
          title: '„ÄêÈü≥‰πê„ÄëÂ§úÁöÑÈí¢Áê¥Êõ≤‰∫î',
          url: 'https://www.bilibili.com/video/BV1234567890',
          status: 'completed',
          progress: 100,
          created_at: '2024-01-15 14:30:00',
          file_size: '5.2MB',
          duration: '3:45'
        },
        {
          id: 2,
          title: '„ÄêASMR„ÄëÈõ®Â£∞ÁôΩÂô™Èü≥ - Âä©Áú†Èü≥È¢ë',
          url: 'https://www.bilibili.com/video/BV0987654321',
          status: 'completed',
          progress: 100,
          created_at: '2024-01-14 20:15:00',
          file_size: '12.8MB',
          duration: '8:20'
        },
        {
          id: 3,
          title: '„ÄêÊïôÁ®ã„ÄëJavaScriptÂÖ•Èó®Âà∞Á≤æÈÄö',
          url: 'https://www.bilibili.com/video/BV1111111111',
          status: 'failed',
          progress: 45,
          created_at: '2024-01-13 16:45:00',
          file_size: '0MB',
          error: 'ÁΩëÁªúËøûÊé•Ë∂ÖÊó∂'
        },
        {
          id: 4,
          title: '„ÄêÈü≥‰πê„ÄëLo-Fi Hip Hop Mix',
          url: 'https://www.bilibili.com/video/BV2222222222',
          status: 'downloading',
          progress: 78,
          created_at: '2024-01-15 15:20:00',
          file_size: '8.5MB',
          duration: '5:30'
        }
      ];
      updateHistoryDisplay();
      updateDownloadStats();
    }

    // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÊòæÁ§∫
    function updateHistoryDisplay() {
      const historyList = document.getElementById('historyList');
      const filteredHistory = filterHistoryData();

      if (filteredHistory.length === 0) {
        historyList.innerHTML = `
          <div class="setting-info" style="text-align: center; color: var(--text-secondary);">
            <span>üìù</span>
            <div>ÊöÇÊó†${getFilterText()}ËÆ∞ÂΩï</div>
          </div>
        `;
        return;
      }

      historyList.innerHTML = filteredHistory.map(item => createHistoryItem(item)).join('');
    }

    // Á≠õÈÄâÂéÜÂè≤Êï∞ÊçÆ
    function filterHistoryData() {
      if (currentFilter === 'all') return downloadHistory;
      return downloadHistory.filter(item => {
        if (currentFilter === 'completed') return item.status === 'completed';
        if (currentFilter === 'failed') return item.status === 'failed';
        return false;
      });
    }

    // Ëé∑ÂèñÁ≠õÈÄâÊñáÊú¨
    function getFilterText() {
      switch (currentFilter) {
        case 'completed': return 'Â∑≤ÂÆåÊàê';
        case 'failed': return 'Â§±Ë¥•';
        default: return '';
      }
    }

    // ÂàõÂª∫ÂéÜÂè≤ËÆ∞ÂΩïÈ°π
    function createHistoryItem(item) {
      const icon = getStatusIcon(item.status);
      const iconClass = getStatusClass(item.status);
      const timeAgo = getTimeAgo(item.created_at);

      return `
        <div class="history-item">
          <div class="history-icon ${iconClass}">
            ${icon}
          </div>
          <div class="history-content">
            <div class="history-title">${item.title}</div>
            <div class="history-meta">
              <span>${timeAgo}</span>
              <span>${item.file_size || 'Êú™Áü•Â§ßÂ∞è'}</span>
              ${item.duration ? `<span>${item.duration}</span>` : ''}
              ${item.error ? `<span style="color: #ff3b30;">ÈîôËØØ: ${item.error}</span>` : ''}
            </div>
            ${item.status === 'downloading' ? `
              <div class="mini-progress">
                <div class="mini-progress-fill" style="width: ${item.progress}%"></div>
              </div>
            ` : ''}
          </div>
          <div class="history-actions">
            <button class="history-btn" onclick="copyUrl('${item.url}')">Â§çÂà∂ÈìæÊé•</button>
            ${item.status === 'failed' ? '<button class="history-btn" onclick="retryDownload(' + item.id + ')">ÈáçËØï</button>' : ''}
            <button class="history-btn" onclick="deleteHistoryItem(' + item.id + ')">Âà†Èô§</button>
          </div>
        </div>
      `;
    }

    // Ëé∑ÂèñÁä∂ÊÄÅÂõæÊ†á
    function getStatusIcon(status) {
      switch (status) {
        case 'completed': return '‚úÖ';
        case 'failed': return '‚ùå';
        case 'downloading': return '‚¨áÔ∏è';
        default: return 'üìÑ';
      }
    }

    // Ëé∑ÂèñÁä∂ÊÄÅÊ†∑ÂºèÁ±ª
    function getStatusClass(status) {
      switch (status) {
        case 'completed': return 'success';
        case 'failed': return 'error';
        case 'downloading': return 'warning';
        default: return '';
      }
    }

    // Ëé∑ÂèñÁõ∏ÂØπÊó∂Èó¥
    function getTimeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffMins < 1) return 'ÂàöÂàö';
      if (diffMins < 60) return `${diffMins}ÂàÜÈíüÂâç`;
      if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
      if (diffDays < 7) return `${diffDays}Â§©Ââç`;
      return date.toLocaleDateString();
    }

    // Êõ¥Êñ∞‰∏ãËΩΩÁªüËÆ°
    function updateDownloadStats() {
      const completed = downloadHistory.filter(item => item.status === 'completed').length;
      const failed = downloadHistory.filter(item => item.status === 'failed').length;
      const total = downloadHistory.length;

      document.getElementById('downloadStats').textContent =
        `ÊÄªËÆ°: ${total} | ÊàêÂäü: ${completed} | Â§±Ë¥•: ${failed}`;
    }

    // Á≠õÈÄâÂéÜÂè≤ËÆ∞ÂΩï
    function filterHistory(type) {
      currentFilter = type;

      // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ - ÈáçÁΩÆÊâÄÊúâÁ≠õÈÄâÊåâÈíÆ
      const allButtons = ['filterAll', 'filterCompleted', 'filterFailed'];
      allButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.style.background = 'var(--bg-tertiary)';
          btn.style.color = 'var(--text-primary)';
        }
      });

      // ÊøÄÊ¥ªÈÄâ‰∏≠ÁöÑÊåâÈíÆ
      const activeBtn = document.getElementById('filter' + type.charAt(0).toUpperCase() + type.slice(1));
      if (activeBtn) {
        activeBtn.style.background = 'var(--accent-color)';
        activeBtn.style.color = 'white';
      }

      updateHistoryDisplay();
    }

    // Â§çÂà∂ÈìæÊé•
    function copyUrl(url) {
      navigator.clipboard.writeText(url).then(() => {
        alert('ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
      }).catch(() => {
        alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂: ' + url);
      });
    }

    // ÊâìÂºÄÊñá‰ª∂
    function openFile(id) {
      alert('ÊâìÂºÄÊñá‰ª∂ÂäüËÉΩÂºÄÂèë‰∏≠...');
    }

    // ÈáçËØï‰∏ãËΩΩ
    function retryDownload(id) {
      const item = downloadHistory.find(h => h.id === id);
      if (item) {
        document.getElementById('urlInput').value = item.url;
        hideSettings();
        alert('Â∑≤Â°´ÂÖ•ÈìæÊé•ÔºåËØ∑ÁÇπÂáªÊ£ÄÊü•ÂàóË°®ÈáçÊñ∞‰∏ãËΩΩ');
      }
    }

    // Âà†Èô§ÂéÜÂè≤ËÆ∞ÂΩïÈ°π
    function deleteHistoryItem(id) {
      if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü')) {
        downloadHistory = downloadHistory.filter(item => item.id !== id);
        updateHistoryDisplay();
        updateDownloadStats();
      }
    }

    // Ê∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩï
    function clearHistory() {
      if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
        downloadHistory = [];
        updateHistoryDisplay();
        updateDownloadStats();
        alert('ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
      }
    }

    // ÂØºÂá∫ÂéÜÂè≤ËÆ∞ÂΩï
    function exportHistory() {
      const data = JSON.stringify(downloadHistory, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lazybala_history_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ÊâìÂºÄ‰∏ãËΩΩÁõÆÂΩï
    function openDownloadFolder() {
      alert('ÊâìÂºÄ‰∏ãËΩΩÁõÆÂΩïÂäüËÉΩÈúÄË¶ÅÁ≥ªÁªüÊîØÊåÅ');
    }

    // ÊµãËØïÊ£ÄÊü•ÂäüËÉΩ
    async function testCheck() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) {
        alert('ËØ∑ËæìÂÖ•ÈìæÊé•');
        return;
      }

      console.log('Ê£ÄÊü•ÈìæÊé•:', url);

      // Á¶ÅÁî®ÊåâÈíÆÂπ∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      const checkBtn = document.querySelector('button[onclick="testCheck()"]');
      const originalText = checkBtn.textContent;
      checkBtn.disabled = true;
      checkBtn.textContent = 'Ê£ÄÊü•‰∏≠...';

      try {
        const response = await fetch('/api/download/precheck', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: url })
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById('resultText').textContent = `${result.title} - ÂÖ±${result.audio_count}ÈõÜ`;
          document.getElementById('resultBox').style.display = 'block';

          // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨‰∏∫"Á°ÆËÆ§‰∏ãËΩΩ"
          const downloadBtn = document.querySelector('#resultBox button[onclick="testDownload()"]');
          if (downloadBtn) {
            downloadBtn.textContent = 'Á°ÆËÆ§‰∏ãËΩΩ';
          }
        } else {
          const error = await response.json();
          alert('Ê£ÄÊü•Â§±Ë¥•: ' + (error.error || 'Êú™Áü•ÈîôËØØ'));
        }
      } catch (error) {
        console.error('Ê£ÄÊü•Â§±Ë¥•:', error);
        alert('Ê£ÄÊü•Â§±Ë¥•: ' + error.message);
      } finally {
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        checkBtn.disabled = false;
        checkBtn.textContent = originalText;
      }
    }

    // Âø´Êç∑ÈîÆÂ§ÑÁêÜÊ£ÄÊü•ÂàóË°®
    function handleCheckList() {
      testCheck();
    }

    // ÊµãËØï‰∏ãËΩΩÂäüËÉΩ
    async function testDownload() {
      const url = document.getElementById('urlInput').value.trim();
      const path = document.getElementById('pathInput').value.trim() || 'test';

      // Á¶ÅÁî®ÊåâÈíÆÂπ∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      const downloadBtn = document.querySelector('#resultBox button[onclick="testDownload()"]');
      const originalText = downloadBtn.textContent;
      downloadBtn.disabled = true;
      downloadBtn.textContent = 'ÂêØÂä®‰∏≠...';

      try {
        // È¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶ÊúâÊ¥ªË∑ÉÁöÑ‰∏ãËΩΩ‰ªªÂä°
        const statusResponse = await fetch('/api/download/status');
        if (statusResponse.ok) {
          const status = await statusResponse.json();
          if (status.isDownloading) {
            // Â¶ÇÊûúÊúâÊ¥ªË∑É‰∏ãËΩΩÔºåËØ¢ÈóÆÁî®Êà∑ÊòØÂê¶ÂÅúÊ≠¢
            if (confirm('Ê£ÄÊµãÂà∞ÊúâÊ≠£Âú®ËøõË°åÁöÑ‰∏ãËΩΩ‰ªªÂä°ÔºåÊòØÂê¶ÂÅúÊ≠¢ÂΩìÂâç‰ªªÂä°Âπ∂ÂºÄÂßãÊñ∞ÁöÑ‰∏ãËΩΩÔºü')) {
              downloadBtn.textContent = 'ÂÅúÊ≠¢‰∏≠...';
              await fetch('/api/download/stop', { method: 'POST' });
              // Á≠âÂæÖ2ÁßíÁ°Æ‰øù‰ªªÂä°ÂÆåÂÖ®ÂÅúÊ≠¢
              await new Promise(resolve => setTimeout(resolve, 2000));
              downloadBtn.textContent = 'ÂêØÂä®‰∏≠...';
            } else {
              downloadBtn.disabled = false;
              downloadBtn.textContent = originalText;
              return;
            }
          }
        }

        // Ëé∑ÂèñÂΩìÂâçËÆæÁΩÆ
        const configResponse = await fetch('/api/config');
        let config = {};
        if (configResponse.ok) {
          config = await configResponse.json();
        }

        const response = await fetch('/api/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url: url,
            save_path: path,
            title_regex: config.title_regex || '%(title)s.%(ext)s',
            quality: config.quality || 'bestaudio/best',
            retry_count: config.retry_count || 5,
            write_thumbnail: config.write_thumbnail !== false
          })
        });

        if (response.ok) {
          document.getElementById('progressBox').style.display = 'block';
          document.getElementById('resultBox').style.display = 'none';

          // ÈáçÁΩÆËøõÂ∫¶ÊòæÁ§∫
          document.getElementById('progressBar').style.width = '0%';
          document.getElementById('progressText').textContent = 'ÂáÜÂ§á‰∏ãËΩΩ...';

          // Á°Æ‰øùWebSocketËøûÊé•
          if (!isConnected) {
            connectWebSocket();
          }
        } else {
          const error = await response.json();

          // Â¶ÇÊûú‰ªçÁÑ∂ÊúâÂÜ≤Á™ÅÔºåÊèê‰æõÊõ¥ËØ¶ÁªÜÁöÑÈîôËØØÂ§ÑÁêÜ
          if (response.status === 409) {
            if (confirm('‰ªçÊúâ‰∏ãËΩΩ‰ªªÂä°Âú®ËøêË°åÔºåÊòØÂê¶Âº∫Âà∂ÂÅúÊ≠¢Âπ∂ÈáçËØïÔºü')) {
              await fetch('/api/download/stop', { method: 'POST' });
              await new Promise(resolve => setTimeout(resolve, 3000));
              // ÈÄíÂΩíÈáçËØï
              downloadBtn.disabled = false;
              downloadBtn.textContent = originalText;
              return testDownload();
            }
          } else {
            alert('‰∏ãËΩΩÂ§±Ë¥•: ' + (error.error || 'Êú™Áü•ÈîôËØØ'));
          }

          // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
          downloadBtn.disabled = false;
          downloadBtn.textContent = originalText;
        }
      } catch (error) {
        console.error('‰∏ãËΩΩÂ§±Ë¥•:', error);
        alert('‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        downloadBtn.disabled = false;
        downloadBtn.textContent = originalText;
      }
    }

    // Ê®°ÊãüËøõÂ∫¶Êõ¥Êñ∞
    function startProgressUpdate() {
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          document.getElementById('progressText').textContent = '‰∏ãËΩΩÂÆåÊàêÔºÅ';
        }

        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = `‰∏ãËΩΩËøõÂ∫¶: ${Math.round(progress)}%`;
      }, 500);
    }

    // ÈöêËóèÁªìÊûú
    function hideResult() {
      document.getElementById('resultBox').style.display = 'none';
    }

    // ÂÅúÊ≠¢‰∏ãËΩΩ
    async function stopDownload() {
      const stopBtn = document.querySelector('button[onclick="stopDownload()"]');

      // Ê£ÄÊü•ÊåâÈíÆÊòØÂê¶Â∑≤Á¶ÅÁî®Ôºà‰∏ãËΩΩÂÆåÊàêÁä∂ÊÄÅÔºâ
      if (stopBtn.disabled) {
        return;
      }

      if (!confirm('Á°ÆÂÆöË¶ÅÂÅúÊ≠¢ÂΩìÂâç‰∏ãËΩΩÂêóÔºü')) {
        return;
      }

      const originalText = stopBtn.textContent;
      stopBtn.disabled = true;
      stopBtn.textContent = 'ÂÅúÊ≠¢‰∏≠...';

      try {
        const response = await fetch('/api/download/stop', { method: 'POST' });

        if (response.ok) {
          // Êõ¥Êñ∞UIÁä∂ÊÄÅ
          document.getElementById('progressText').textContent = '‰∏ãËΩΩÂ∑≤ÂÅúÊ≠¢';

          // Êõ¥Êñ∞Èò∂ÊÆµÁä∂ÊÄÅ
          const phaseEl = document.getElementById('downloadPhase');
          if (phaseEl) {
            phaseEl.textContent = 'Â∑≤ÂÅúÊ≠¢';
            phaseEl.className = 'download-phase error';
          }

          // 3ÁßíÂêéÈöêËóèËøõÂ∫¶Ê°Ü
          setTimeout(() => {
            document.getElementById('progressBox').style.display = 'none';
          }, 3000);
        } else {
          alert('ÂÅúÊ≠¢‰∏ãËΩΩÂ§±Ë¥•');
          stopBtn.disabled = false;
          stopBtn.textContent = originalText;
        }
      } catch (error) {
        console.error('ÂÅúÊ≠¢‰∏ãËΩΩÂ§±Ë¥•:', error);
        alert('ÂÅúÊ≠¢‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
        stopBtn.disabled = false;
        stopBtn.textContent = originalText;
      }
    }



    // Ëé∑ÂèñÁä∂ÊÄÅÊñáÊú¨
    function getStatusText(status) {
      const statusMap = {
        'completed': 'Â∑≤ÂÆåÊàê',
        'failed': 'Â§±Ë¥•',
        'downloading': '‰∏ãËΩΩ‰∏≠',
        'stopped': 'Â∑≤ÂÅúÊ≠¢',
        'pending': 'Á≠âÂæÖ‰∏≠',
        'paused': 'Â∑≤ÊöÇÂÅú'
      };
      return statusMap[status] || status;
    }

    // ÊöÇÂÅú/ÊÅ¢Â§ç‰∏ãËΩΩ
    async function pauseResumeDownload() {
      const pauseBtn = document.getElementById('pauseResumeBtn');
      const isPaused = pauseBtn.textContent.includes('ÊÅ¢Â§ç');
      const action = isPaused ? 'resume' : 'pause';

      const originalText = pauseBtn.textContent;
      pauseBtn.disabled = true;
      pauseBtn.textContent = isPaused ? 'ÊÅ¢Â§ç‰∏≠...' : 'ÊöÇÂÅú‰∏≠...';

      try {
        const response = await fetch(`/api/download/${action}`, { method: 'POST' });

        if (response.ok) {
          // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
          pauseBtn.textContent = isPaused ? 'ÊöÇÂÅú‰∏ãËΩΩ' : 'ÊÅ¢Â§ç‰∏ãËΩΩ';

          // Êõ¥Êñ∞ËøõÂ∫¶ÊñáÊú¨
          const progressText = document.getElementById('progressText');
          if (progressText) {
            if (isPaused) {
              progressText.textContent = progressText.textContent.replace('Â∑≤ÊöÇÂÅú', '‰∏ãËΩΩ‰∏≠');
            } else {
              progressText.textContent = progressText.textContent + ' (Â∑≤ÊöÇÂÅú)';
            }
          }

          // Êõ¥Êñ∞Èò∂ÊÆµÁä∂ÊÄÅ
          const phaseEl = document.getElementById('downloadPhase');
          if (phaseEl) {
            if (isPaused) {
              phaseEl.textContent = '‰∏ãËΩΩ‰∏≠';
              phaseEl.className = 'download-phase downloading';
            } else {
              phaseEl.textContent = 'Â∑≤ÊöÇÂÅú';
              phaseEl.className = 'download-phase warning';
            }
          }
        } else {
          alert(`${isPaused ? 'ÊÅ¢Â§ç' : 'ÊöÇÂÅú'}‰∏ãËΩΩÂ§±Ë¥•`);
          pauseBtn.textContent = originalText;
        }
      } catch (error) {
        console.error(`${action}‰∏ãËΩΩÂ§±Ë¥•:`, error);
        alert(`${isPaused ? 'ÊÅ¢Â§ç' : 'ÊöÇÂÅú'}‰∏ãËΩΩÂ§±Ë¥•: ` + error.message);
        pauseBtn.textContent = originalText;
      } finally {
        pauseBtn.disabled = false;
      }
    }

    // ÈáçÊñ∞‰∏ãËΩΩ
    async function restartDownload() {
      if (!confirm('Á°ÆÂÆöË¶ÅÈáçÊñ∞‰∏ãËΩΩÂΩìÂâçÈ°πÁõÆÂêóÔºü\nËøôÂ∞ÜÊ∏ÖÈô§ÂΩìÂâçËøõÂ∫¶Âπ∂ÈáçÊñ∞ÂºÄÂßã„ÄÇ')) {
        return;
      }

      const restartBtn = document.getElementById('restartBtn');
      const originalText = restartBtn.textContent;
      restartBtn.disabled = true;
      restartBtn.textContent = 'ÈáçÂêØ‰∏≠...';

      try {
        // ÂÖàÂÅúÊ≠¢ÂΩìÂâç‰∏ãËΩΩ
        await fetch('/api/download/stop', { method: 'POST' });

        // Á≠âÂæÖ‰∏ÄÁßíÂêéÈáçÊñ∞ÂºÄÂßã
        setTimeout(async () => {
          try {
            await testDownload();
            restartBtn.style.display = 'none';
          } catch (error) {
            console.error('ÈáçÊñ∞‰∏ãËΩΩÂ§±Ë¥•:', error);
            alert('ÈáçÊñ∞‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
            restartBtn.disabled = false;
            restartBtn.textContent = originalText;
          }
        }, 1000);
      } catch (error) {
        console.error('ÈáçÊñ∞‰∏ãËΩΩÂ§±Ë¥•:', error);
        alert('ÈáçÊñ∞‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
        restartBtn.disabled = false;
        restartBtn.textContent = originalText;
      }
    }

    // WebSocketËøûÊé•ÂíåËøõÂ∫¶Êõ¥Êñ∞
    let ws = null;
    let isConnected = false;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    // Áîü‰∫ßÁéØÂ¢ÉÈÖçÁΩÆ
    const appConfig = {
      wsUrl: `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`,
      apiBase: '/api',
      reconnectInterval: 3000,
      heartbeatInterval: 30000,
      version: '1.0.0'
    };

    function connectWebSocket() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        console.log('WebSocketÂ∑≤ËøûÊé•');
        return;
      }

      console.log('ËøûÊé•WebSocket:', appConfig.wsUrl);

      ws = new WebSocket(appConfig.wsUrl);

      ws.onopen = function() {
        console.log('WebSocketËøûÊé•ÊàêÂäü');
        isConnected = true;
        reconnectAttempts = 0; // ÈáçÁΩÆÈáçËøûËÆ°Êï∞
        updateConnectionStatus(true);
      };

      ws.onmessage = function(event) {
        console.log('Êî∂Âà∞WebSocketÊ∂àÊÅØ:', event.data);
        try {
          const message = JSON.parse(event.data);
          if (message.type === 'progress') {
            updateProgressDisplay(message.data);
          }
        } catch (e) {
          console.error('Ëß£ÊûêWebSocketÊ∂àÊÅØÂ§±Ë¥•:', e);
        }
      };

      ws.onclose = function() {
        console.log('WebSocketËøûÊé•ÂÖ≥Èó≠');
        isConnected = false;
        updateConnectionStatus(false);

        // Êô∫ËÉΩÈáçËøûÊú∫Âà∂
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          const delay = Math.min(appConfig.reconnectInterval * reconnectAttempts, 30000);
          console.log(`${delay}msÂêéÂ∞ùËØïÁ¨¨${reconnectAttempts}Ê¨°ÈáçËøû`);
          setTimeout(connectWebSocket, delay);
        } else {
          console.log('ËææÂà∞ÊúÄÂ§ßÈáçËøûÊ¨°Êï∞ÔºåÂÅúÊ≠¢ÈáçËøû');
        }
      };

      ws.onerror = function(error) {
        console.error('WebSocketÈîôËØØ:', error);
        isConnected = false;
        updateConnectionStatus(false);
      };
    }

    // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('wsStatus');
      if (statusEl) {
        statusEl.textContent = connected ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•';
        statusEl.className = connected ? 'ws-status connected' : 'ws-status disconnected';
      }
    }

    // Êõ¥Êñ∞ËøõÂ∫¶ÊòæÁ§∫
    function updateProgressDisplay(progress) {
      console.log('Êõ¥Êñ∞ËøõÂ∫¶ÊòæÁ§∫:', progress);

      // ÊòæÁ§∫ËøõÂ∫¶Ê°Ü
      document.getElementById('progressBox').style.display = 'block';

      // Ê£ÄÊü•‰∏ãËΩΩÊòØÂê¶ÂÆåÊàê
      const isCompleted = progress.phase === 'completed' || (!progress.isDownloading && progress.progress >= 100);

      // Êõ¥Êñ∞ÂÅúÊ≠¢‰∏ãËΩΩÊåâÈíÆÁä∂ÊÄÅ
      const stopButton = document.querySelector('button[onclick="stopDownload()"]');
      if (stopButton) {
        stopButton.disabled = isCompleted;
        stopButton.style.opacity = isCompleted ? '0.5' : '1';
        stopButton.style.cursor = isCompleted ? 'not-allowed' : 'pointer';
      }

      // Êõ¥Êñ∞ÊöÇÂÅú/ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
      const pauseButton = document.getElementById('pauseResumeBtn');
      if (pauseButton) {
        if (progress.isDownloading && !isCompleted) {
          pauseButton.style.display = 'inline-block';
          pauseButton.disabled = false;

          // Ê†πÊçÆÊöÇÂÅúÁä∂ÊÄÅÊõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
          if (progress.isPaused) {
            pauseButton.textContent = 'ÊÅ¢Â§ç‰∏ãËΩΩ';
          } else {
            pauseButton.textContent = 'ÊöÇÂÅú‰∏ãËΩΩ';
          }
        } else {
          pauseButton.style.display = 'none';
        }
      }

      // Êõ¥Êñ∞ÈáçÊñ∞‰∏ãËΩΩÊåâÈíÆÁä∂ÊÄÅ
      const restartButton = document.getElementById('restartBtn');
      if (restartButton) {
        if (isCompleted || (!progress.isDownloading && progress.progress > 0)) {
          restartButton.style.display = 'inline-block';
          restartButton.disabled = false;
        } else {
          restartButton.style.display = 'none';
        }
      }

      // Â¶ÇÊûú‰∏ãËΩΩÂÆåÊàê‰∏î‰∏çÂÜç‰∏ãËΩΩ‰∏≠Ôºå‰øùÊåÅÊòæÁ§∫‰ΩÜÁ¶ÅÁî®ÊéßÂà∂
      if (!progress.isDownloading && isCompleted) {
        console.log('‰∏ãËΩΩÂ∑≤ÂÆåÊàêÔºå‰øùÊåÅÊòæÁ§∫ËøõÂ∫¶Ê°Ü');
        // ‰∏çÈöêËóèËøõÂ∫¶Ê°ÜÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÂÆåÊàêÁä∂ÊÄÅ
      }

      // Êõ¥Êñ∞Âü∫Êú¨ËøõÂ∫¶‰ø°ÊÅØ
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const statusText = document.getElementById('statusText');

      if (progressBar) {
        progressBar.style.width = `${progress.progress || 0}%`;
      }

      if (progressText) {
        progressText.textContent = `${(progress.progress || 0).toFixed(1)}%`;
      }

      if (statusText) {
        statusText.textContent = progress.status || '‰∏ãËΩΩ‰∏≠...';
      }

      // Êõ¥Êñ∞ËØ¶ÁªÜ‰ø°ÊÅØ
      updateDetailedProgress(progress);
    }

    // Êõ¥Êñ∞ËØ¶ÁªÜËøõÂ∫¶‰ø°ÊÅØ
    function updateDetailedProgress(progress) {
      // Êõ¥Êñ∞ÂΩìÂâçÊñá‰ª∂‰ø°ÊÅØ
      const currentFileEl = document.getElementById('currentFile');
      if (currentFileEl && progress.currentTitle) {
        currentFileEl.textContent = `ÂΩìÂâç: ${progress.currentTitle}`;
      }

      // Êõ¥Êñ∞Êí≠ÊîæÂàóË°®ËøõÂ∫¶
      const playlistProgressEl = document.getElementById('playlistProgress');
      if (playlistProgressEl && progress.totalCount > 0) {
        let progressText = `È°πÁõÆ: ${progress.currentIndex || 0}/${progress.totalCount}`;
        if (progress.fileProgress !== undefined && progress.fileProgress !== progress.progress) {
          progressText += ` (ÂΩìÂâçÊñá‰ª∂: ${progress.fileProgress.toFixed(1)}%)`;
        }
        playlistProgressEl.textContent = progressText;
        playlistProgressEl.style.display = 'block';
      } else if (playlistProgressEl) {
        playlistProgressEl.style.display = 'none';
      }

      // Êõ¥Êñ∞ÈÄüÂ∫¶ÂíåETA
      const speedEl = document.getElementById('downloadSpeed');
      if (speedEl && progress.speed) {
        speedEl.textContent = `ÈÄüÂ∫¶: ${progress.speed}`;
        speedEl.style.display = 'block';
      } else if (speedEl) {
        speedEl.style.display = 'none';
      }

      const etaEl = document.getElementById('downloadETA');
      if (etaEl && progress.eta) {
        etaEl.textContent = `Ââ©‰Ωô: ${progress.eta}`;
        etaEl.style.display = 'block';
      } else if (etaEl) {
        etaEl.style.display = 'none';
      }

      // Êõ¥Êñ∞Êñá‰ª∂Â§ßÂ∞è
      const fileSizeEl = document.getElementById('fileSize');
      if (fileSizeEl && progress.fileSize) {
        fileSizeEl.textContent = `Â§ßÂ∞è: ${progress.fileSize}`;
        fileSizeEl.style.display = 'block';
      } else if (fileSizeEl) {
        fileSizeEl.style.display = 'none';
      }

      // Êõ¥Êñ∞Èò∂ÊÆµ‰ø°ÊÅØ
      const phaseEl = document.getElementById('downloadPhase');
      if (phaseEl && progress.phase) {
        const phaseText = getPhaseText(progress.phase);
        phaseEl.textContent = phaseText;
        phaseEl.className = `download-phase ${progress.phase}`;
      }

      // Êõ¥Êñ∞ÂÖÉÊï∞ÊçÆ‰ø°ÊÅØ
      updateMetadataDisplay(progress);

      // Êõ¥Êñ∞Â∑≤ÂÆåÊàêÊñá‰ª∂ÂàóË°®
      updateCompletedFiles(progress.completedFiles);
    }

    // Ëé∑ÂèñÈò∂ÊÆµÊñáÊú¨
    function getPhaseText(phase) {
      const phaseMap = {
        'initializing': 'ÂàùÂßãÂåñ‰∏≠',
        'extracting': 'ÊèêÂèñ‰ø°ÊÅØ‰∏≠',
        'downloading': '‰∏ãËΩΩ‰∏≠',
        'merging': 'ÂêàÂπ∂‰∏≠',
        'completed': 'Â∑≤ÂÆåÊàê',
        'error': 'Âá∫Áé∞ÈîôËØØ'
      };
      return phaseMap[phase] || phase;
    }

    // Êõ¥Êñ∞ÂÖÉÊï∞ÊçÆÊòæÁ§∫
    function updateMetadataDisplay(progress) {
      const metadataEl = document.getElementById('metadata');
      if (!metadataEl) return;

      let metadataHtml = '';

      if (progress.duration) {
        metadataHtml += `<div class="metadata-item">‚è±Ô∏è Êó∂Èïø: ${progress.duration}</div>`;
      }

      if (progress.uploader) {
        metadataHtml += `<div class="metadata-item">üë§ ‰∏ä‰º†ËÄÖ: ${progress.uploader}</div>`;
      }

      if (progress.viewCount) {
        metadataHtml += `<div class="metadata-item">üëÅÔ∏è Êí≠ÊîæÈáè: ${progress.viewCount}</div>`;
      }

      if (progress.playlistTitle) {
        metadataHtml += `<div class="metadata-item">üìã Êí≠ÊîæÂàóË°®: ${progress.playlistTitle}</div>`;
      }

      metadataEl.innerHTML = metadataHtml;
      metadataEl.style.display = metadataHtml ? 'block' : 'none';
    }

    // Êõ¥Êñ∞Â∑≤ÂÆåÊàêÊñá‰ª∂ÂàóË°®
    function updateCompletedFiles(completedFiles) {
      const completedEl = document.getElementById('completedFiles');
      if (!completedEl || !completedFiles || completedFiles.length === 0) {
        if (completedEl) completedEl.style.display = 'none';
        return;
      }

      const filesHtml = completedFiles.map(file =>
        `<div class="completed-file">‚úÖ ${file}</div>`
      ).join('');

      completedEl.innerHTML = `<div class="completed-title">Â∑≤ÂÆåÊàê:</div>${filesHtml}`;
      completedEl.style.display = 'block';
    }

    // È°µÈù¢Âä†ËΩΩÊó∂ËøûÊé•WebSocket
    document.addEventListener('DOMContentLoaded', function() {
      try {
        console.log(`LazyBala v${appConfig.version} ÂàùÂßãÂåñ‰∏≠...`);

        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        initTheme();

        // ËøûÊé•WebSocket
        connectWebSocket();

        // Ê£ÄÊü•Á≥ªÁªüÁä∂ÊÄÅ
        checkSystemStatus();

        // ËÆæÁΩÆÈîÆÁõòÂø´Êç∑ÈîÆ
        setupKeyboardShortcuts();

        // ËÆæÁΩÆÈ°µÈù¢ÂèØËßÅÊÄßÊ£ÄÊµã
        setupVisibilityChange();

        // Âä†ËΩΩÈÖçÁΩÆÂíåÂéÜÂè≤ËÆ∞ÂΩï
        refreshHistory();
        updateDownloadStats();

        // ÂàùÂßãÂåñÁâàÊú¨‰ø°ÊÅØ
        initVersionInfo();

        console.log('È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
      } catch (error) {
        console.error('È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•:', error);
        alert('È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
      }
    });

    // ÂàùÂßãÂåñÁâàÊú¨‰ø°ÊÅØ
    async function initVersionInfo() {
      try {
        const response = await fetch('/api/version/check');
        if (response.ok) {
          const data = await response.json();
          const versionText = document.getElementById('versionText');
          if (versionText) {
            versionText.textContent = `LazyBala: ${data.app.current} | yt-dlp: ${data.ytdlp.current}`;
          }
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÁâàÊú¨‰ø°ÊÅØÂ§±Ë¥•:', error);
      }
    }

    // ËÆæÁΩÆÈ°µÈù¢ÂèØËßÅÊÄßÊ£ÄÊµã
    function setupVisibilityChange() {
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          console.log('È°µÈù¢ÈöêËóè');
        } else {
          console.log('È°µÈù¢ÊòæÁ§∫ÔºåÊ£ÄÊü•WebSocketËøûÊé•');
          if (!isConnected) {
            connectWebSocket();
          }
        }
      });
    }

    // ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜ
    window.addEventListener('error', function(e) {
      console.error('ÂÖ®Â±ÄÈîôËØØ:', e.error);
    });

    window.addEventListener('unhandledrejection', function(e) {
      console.error('Êú™Â§ÑÁêÜÁöÑPromiseÊãíÁªù:', e.reason);
      e.preventDefault(); // Èò≤Ê≠¢ÈîôËØØÊòæÁ§∫Âú®ÊéßÂà∂Âè∞
    });
  </script>
</body>
</html>
